<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üë§ Mon Profil - Plateforme Agricole</title>

  <!-- Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="css/common-fonts.css" rel="stylesheet">
  <link href="css/language.css" rel="stylesheet">

  <style>
    :root {
      --primary-color: #88c9a1;  /* Vert doux */
      --secondary-color: #f7a278;  /* Orange p√™che */
      --accent-color: #6a8d92;  /* Bleu-vert */
      --light-color: #f8f4e3;  /* Cr√®me clair */
      --dark-color: #5a5a5a;
    }

    body {
      background-color: var(--light-color);
      padding: 20px;
    }

    .header {
      background-color: var(--primary-color);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      color: white;
      text-align: center;
      position: relative;
    }

    .header h1 {
      color: white;
      margin: 0;
      font-size: 2.2rem;
    }

    .header .subtitle {
      color: white;
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .back-btn {
      position: absolute;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background-color: rgba(255, 255, 255, 0.2);
      border: none;
      color: white;
      padding: 8px 15px;
      border-radius: 20px;
      cursor: pointer;
      transition: background-color 0.3s;
    }

    .back-btn:hover {
      background-color: rgba(255, 255, 255, 0.3);
    }

    .profile-card {
      background-color: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .profile-card h2 {
      color: var(--dark-color);
      font-size: 1.5rem;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }

    .profile-header {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
    }

    .profile-avatar {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      border: 3px solid var(--primary-color);
      margin-right: 20px;
    }

    .profile-info h3 {
      margin: 0;
      color: var(--dark-color);
      font-size: 1.5rem;
    }

    .profile-info p {
      margin: 5px 0 0;
      color: #777;
    }

    .profile-badge {
      display: inline-block;
      padding: 5px 10px;
      border-radius: 20px;
      font-size: 0.8rem;
      font-weight: 500;
      margin-top: 5px;
    }

    .badge-admin {
      background-color: #28a745;
      color: white;
    }

    .badge-user {
      background-color: #6c757d;
      color: white;
    }

    .form-label {
      font-weight: 500;
      color: var(--dark-color);
    }

    .btn-save {
      background-color: var(--primary-color);
      border: none;
      padding: 10px 20px;
      transition: background-color 0.3s;
    }

    .btn-save:hover {
      background-color: #76b78f;
    }

    .custom-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: none;
      min-width: 300px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .activity-item {
      padding: 15px;
      border-bottom: 1px solid #eee;
    }

    .activity-item:last-child {
      border-bottom: none;
    }

    .activity-date {
      font-size: 0.8rem;
      color: #777;
    }

    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #f0f0f0;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 15px;
    }

    .activity-icon.login {
      background-color: #e3f2fd;
      color: #1976d2;
    }

    .activity-icon.edit {
      background-color: #e8f5e9;
      color: #388e3c;
    }

    .activity-icon.settings {
      background-color: #fff3e0;
      color: #f57c00;
    }

    .form-control-plaintext {
      padding: 0.375rem 0.75rem;
      background-color: #f8f9fa;
      border-radius: 0.25rem;
      margin-bottom: 0;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div id="customAlert" class="custom-alert alert alert-dismissible fade show" role="alert">
    <span id="alertMessage"></span>
    <button type="button" class="btn-close" onclick="hideAlert()"></button>
  </div>

  <div class="container-fluid">
    <div class="header">
      <button class="back-btn" id="backButton">
        <i class="fas fa-arrow-left me-1"></i> <span class="lang-text" data-lang-key="back_to_dashboard">Tableau de bord</span>
      </button>
      <h1><i class="fas fa-user-circle me-2"></i> <span class="lang-text" data-lang-key="profile">Mon Profil</span></h1>
      <div class="subtitle">üåµ <span class="lang-text" data-lang-key="region">R√©gion de B√©char - Alg√©rie</span> üåû</div>
    </div>

    <div class="row">
      <div class="col-md-8 mx-auto">
        <div class="profile-card">
          <div class="profile-header">
            <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Avatar" class="profile-avatar">
            <div class="profile-info">
              <h3 id="userName">Chargement...</h3>
              <p id="userEmail">Chargement...</p>
              <span id="userRole" class="profile-badge">Chargement...</span>
            </div>
          </div>

          <h2><i class="fas fa-id-card me-2"></i> <span class="lang-text" data-lang-key="personal_info">Informations Personnelles</span></h2>

          <div class="mb-3">
            <label class="form-label"><span class="lang-text" data-lang-key="full_name">Nom Complet</span></label>
            <p class="form-control-plaintext" id="fullName">Chargement...</p>
          </div>

          <div class="mb-3">
            <label class="form-label"><span class="lang-text" data-lang-key="user_email">Email</span></label>
            <p class="form-control-plaintext" id="userEmailDisplay">Chargement...</p>
          </div>

          <div class="mb-3">
            <label class="form-label"><span class="lang-text" data-lang-key="username">Nom d'utilisateur</span></label>
            <p class="form-control-plaintext" id="usernameDisplay">Chargement...</p>
          </div>

          <div class="mb-3">
            <label class="form-label"><span class="lang-text" data-lang-key="role">R√¥le</span></label>
            <p class="form-control-plaintext" id="userRoleDisplay">Chargement...</p>
          </div>

          <div class="alert alert-info">
            <i class="fas fa-info-circle me-2"></i>
            <span class="lang-text" data-lang-key="profile_readonly">Les informations du profil sont en lecture seule. Seul le mot de passe peut √™tre modifi√©.</span>
          </div>
        </div>

        <div class="profile-card">
          <h2><i class="fas fa-key me-2"></i> <span class="lang-text" data-lang-key="security">S√©curit√©</span></h2>

          <form id="securityForm">
            <div class="mb-3">
              <label for="currentPassword" class="form-label"><span class="lang-text" data-lang-key="current_password">Mot de passe actuel</span></label>
              <input type="password" class="form-control" id="currentPassword" required>
            </div>

            <div class="mb-3">
              <label for="newPassword" class="form-label"><span class="lang-text" data-lang-key="new_password">Nouveau mot de passe</span></label>
              <input type="password" class="form-control" id="newPassword" required>
            </div>

            <div class="mb-4">
              <label for="confirmPassword" class="form-label"><span class="lang-text" data-lang-key="confirm_password">Confirmer le mot de passe</span></label>
              <input type="password" class="form-control" id="confirmPassword" required>
            </div>

            <div class="d-grid gap-2 d-md-flex justify-content-md-end">
              <button type="submit" class="btn btn-primary btn-save">
                <i class="fas fa-save me-2"></i> <span class="lang-text" data-lang-key="update">Mettre √† jour</span>
              </button>
            </div>
          </form>
        </div>

        <div class="profile-card">
          <h2><i class="fas fa-history me-2"></i> <span class="lang-text" data-lang-key="recent_activity">Activit√© R√©cente</span></h2>

          <div id="activityList">
            <!-- Activity items will be loaded here dynamically -->
            <p class="text-center py-3">Chargement des activit√©s...</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/auth.js"></script>
  <script src="js/language.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in
      if (!window.Auth.isLoggedIn()) {
        window.location.href = 'login.html';
        return;
      }

      // Set back button based on user role
      const userRole = window.Auth.getCurrentUserRole();
      const backButton = document.getElementById('backButton');
      if (userRole === 'employe') {
        backButton.onclick = function() {
          window.location.href = 'dashboard_employe.html';
        };
      } else {
        backButton.onclick = function() {
          window.location.href = 'dashboard.html';
        };
      }

      // Load language
      loadLanguage();

      // Load user data
      loadUserData();

      // Load activity
      loadActivity();

      // Handle security form submission
      document.getElementById('securityForm').addEventListener('submit', function(e) {
        e.preventDefault();
        updatePassword();
      });
    });

    // Show alert message
    function showAlert(type, message) {
      const alertElement = document.getElementById('customAlert');
      alertElement.className = `custom-alert alert alert-${type} alert-dismissible fade show`;
      document.getElementById('alertMessage').textContent = message;
      alertElement.style.display = 'block';
      
      // Hide after 5 seconds
      setTimeout(hideAlert, 5000);
    }

    // Hide alert message
    function hideAlert() {
      document.getElementById('customAlert').style.display = 'none';
    }

    // Load user data from API
    function loadUserData() {
      // Get current user data
      const userData = window.Auth.getCurrentUser();
      
      if (!userData) {
        showAlert('danger', 'Erreur lors du chargement des donn√©es utilisateur');
        return;
      }
      
      // Update profile header
      document.getElementById('userName').textContent = userData.name || userData.username;
      document.getElementById('userEmail').textContent = userData.email || '';
      
      const roleBadge = document.getElementById('userRole');
      const roleText = userData.role === 'gestionnaire' ? 'Gestionnaire' : 'Employ√©';
      roleBadge.textContent = roleText;
      roleBadge.className = `profile-badge ${userData.role === 'gestionnaire' ? 'badge-admin' : 'badge-user'}`;
      
      // Update profile information
      document.getElementById('fullName').textContent = userData.name || '';
      document.getElementById('userEmailDisplay').textContent = userData.email || '';
      document.getElementById('usernameDisplay').textContent = userData.username || '';
      document.getElementById('userRoleDisplay').textContent = roleText;
    }

    // Update password
    function updatePassword() {
      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;
      
      // Validate inputs
      if (!currentPassword) {
        showAlert('danger', 'Le mot de passe actuel est requis');
        return;
      }
      
      if (!newPassword) {
        showAlert('danger', 'Le nouveau mot de passe est requis');
        return;
      }
      
      if (newPassword !== confirmPassword) {
        showAlert('danger', 'Les mots de passe ne correspondent pas');
        return;
      }
      
      // Make API request to update password
      fetch('/api/update-password.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          current_password: currentPassword,
          new_password: newPassword
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Clear form
          document.getElementById('securityForm').reset();
          
          // Show success message
          showAlert('success', 'Mot de passe mis √† jour avec succ√®s');
          
          // Add activity
          addActivity('password_change', 'Mot de passe modifi√©');
        } else {
          showAlert('danger', data.message || 'Erreur lors de la mise √† jour du mot de passe');
        }
      })
      .catch(error => {
        console.error('Error updating password:', error);
        showAlert('danger', 'Erreur lors de la mise √† jour du mot de passe');
      });
    }

    // Load activity
    function loadActivity() {
      // Make API request to get user activity
      fetch('/api/user-activity.php')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            renderActivities(data.activities);
          } else {
            document.getElementById('activityList').innerHTML = '<p class="text-center py-3">Aucune activit√© r√©cente</p>';
          }
        })
        .catch(error => {
          console.error('Error loading activities:', error);
          document.getElementById('activityList').innerHTML = '<p class="text-center py-3">Erreur lors du chargement des activit√©s</p>';
        });
    }

    // Add activity
    function addActivity(type, description) {
      // Make API request to add activity
      fetch('/api/add-activity.php', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          type: type,
          description: description
        })
      })
      .then(response => response.json())
      .then(data => {
        if (data.success) {
          // Reload activities
          loadActivity();
        }
      })
      .catch(error => {
        console.error('Error adding activity:', error);
      });
    }

    // Render activities
    function renderActivities(activities) {
      const activityList = document.getElementById('activityList');
      
      if (!activities || activities.length === 0) {
        activityList.innerHTML = '<p class="text-center py-3">Aucune activit√© r√©cente</p>';
        return;
      }
      
      activityList.innerHTML = activities.map(activity => {
        const date = new Date(activity.created_at);
        const formattedDate = date.toLocaleDateString('fr-FR', {
          day: '2-digit',
          month: '2-digit',
          year: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });
        
        let iconClass = 'fas fa-info-circle';
        let iconBgClass = '';
        
        switch (activity.type) {
          case 'login':
            iconClass = 'fas fa-sign-in-alt';
            iconBgClass = 'login';
            break;
          case 'password_change':
            iconClass = 'fas fa-key';
            iconBgClass = 'settings';
            break;
          case 'profile_update':
            iconClass = 'fas fa-user-edit';
            iconBgClass = 'edit';
            break;
        }
        
        return `
          <div class="activity-item d-flex align-items-center">
            <div class="activity-icon ${iconBgClass}">
              <i class="${iconClass}"></i>
            </div>
            <div class="flex-grow-1">
              <div>${activity.description}</div>
              <div class="activity-date">${formattedDate}</div>
            </div>
          </div>
        `;
      }).join('');
    }
  </script>
</body>
</html>
