<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>üå± Tableau de Bord Agricole - B√©char</title>

  <!-- Styles -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.css" rel="stylesheet">
  <link href="css/common-fonts.css" rel="stylesheet">
  <link href="css/language.css" rel="stylesheet">

  <style>
    :root {
      --primary-color: #88c9a1;  /* Vert doux */
      --secondary-color: #f7a278;  /* Orange p√™che */
      --accent-color: #6a8d92;  /* Bleu-vert */
      --light-color: #f8f4e3;  /* Cr√®me clair */
      --dark-color: #5a5a5a;
      --irrigation: #64B5F6;
      --fertilisation: #9b59b6;
      --recolte: #e74c3c;
      --traitement: #f39c12;
      --autre: #2ecc71;
    }

    body {
      background-color: var(--light-color);
    }

    .header {
      background-color: var(--primary-color);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      color: white;
      text-align: center;
    }

    .header h1 {
      color: white;
      margin: 0;
      font-size: 2.2rem;
    }

    .header .subtitle {
      color: white;
      font-size: 1.1rem;
      opacity: 0.9;
    }

    .panel {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }

    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 2px dashed var(--primary-color);
    }

    .panel-title {
      color: var(--dark-color);
      margin: 0;
      font-size: 1.4rem;
    }

    .btn-cute {
      background-color: var(--secondary-color);
      color: white;
      border: none;
      border-radius: 50px;
      padding: 8px 20px;
      font-weight: 600;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      transition: all 0.3s;
    }

    .btn-cute:hover {
      background-color: #e8916a;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }

    .btn-danger-cute {
      background-color: #ff6b6b;
      color: white;
      border: none;
      border-radius: 50px;
      padding: 8px 20px;
      font-weight: 600;
      box-shadow: 0 3px 6px rgba(0,0,0,0.1);
      transition: all 0.3s;
      margin-left: 10px;
    }

    .btn-danger-cute:hover {
      background-color: #ff5252;
      color: white;
      transform: translateY(-2px);
      box-shadow: 0 5px 10px rgba(0,0,0,0.15);
    }

    .sensor-card {
      background: linear-gradient(135deg, var(--primary-color) 0%, #7ab992 100%);
      color: white;
      border-radius: 12px;
      padding: 15px;
      margin-bottom: 15px;
    }

    .sensor-item {
      display: flex;
      align-items: center;
      padding: 8px 0;
      border-bottom: 1px solid rgba(255,255,255,0.2);
    }

    .sensor-item:last-child {
      border-bottom: none;
    }

    .sensor-icon {
      width: 30px;
      text-align: center;
      margin-right: 10px;
      font-size: 1.2rem;
    }

    .sensor-value {
      margin-left: auto;
      font-weight: bold;
      font-size: 1.1rem;
    }

    .weather-card {
      background: linear-gradient(135deg, var(--accent-color) 0%, #5a7d82 100%);
      color: white;
      border-radius: 12px;
      padding: 15px;
    }

    .weather-icon {
      font-size: 2rem;
      margin-right: 10px;
    }

    .forecast-day {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px;
      background: rgba(255,255,255,0.15);
      border-radius: 8px;
      margin-bottom: 8px;
      transition: all 0.3s;
    }

    .forecast-day:hover {
      transform: translateX(5px);
      background: rgba(255,255,255,0.25);
    }

    .map-container {
      height: 300px;
      width: 100%;
      border-radius: 12px;
      overflow: hidden;
      position: relative;
    }

    .map-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 10px;
      z-index: 1000;
    }

    .stats-card {
      text-align: center;
      padding: 15px;
      border-radius: 12px;
      color: white;
      margin-bottom: 15px;
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .stats-value {
      font-size: 2rem;
      font-weight: 700;
      margin: 10px 0;
    }

    .stats-label {
      font-size: 0.9rem;
      opacity: 0.9;
    }

    .info-card {
      background-color: white;
      border-radius: 12px;
      padding: 15px;
    }

    .info-item {
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }

    .info-icon {
      color: var(--primary-color);
      margin-right: 10px;
      width: 25px;
      text-align: center;
    }

    .nav-tabs .nav-link {
      border: none;
      color: var(--dark-color);
      font-weight: 500;
      padding: 10px 20px;
    }

    .nav-tabs .nav-link.active {
      color: var(--primary-color);
      border-bottom: 3px solid var(--primary-color);
      background-color: transparent;
    }

    .tab-content {
      padding: 20px 0;
    }

    .sidebar {
      background-color: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .sidebar-item {
      padding: 10px 0;
      border-bottom: 1px solid rgba(0,0,0,0.05);
    }

    .sidebar-item:last-child {
      border-bottom: none;
    }

    .sidebar-link {
      color: var(--dark-color);
      text-decoration: none;
      display: flex;
      align-items: center;
    }

    .sidebar-link:hover {
      color: var(--primary-color);
    }

    .sidebar-icon {
      margin-right: 10px;
      width: 20px;
      text-align: center;
    }

    .custom-alert {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1050;
      min-width: 300px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      border: none;
      border-left: 5px solid;
      animation: slideIn 0.5s forwards;
      display: none;
      border-radius: 10px;
    }

    .alert-success-custom {
      background-color: #d4edda;
      color: #155724;
      border-left-color: #28a745;
    }

    .alert-danger-custom {
      background-color: #f8d7da;
      color: #721c24;
      border-left-color: #dc3545;
    }

    /* Style am√©lior√© pour les alertes critiques */
    .alert-danger-custom {
      background-color: #dc3545;
      color: white;
      border-left-color: #b02a37;
      font-weight: bold;
      box-shadow: 0 4px 20px rgba(220, 53, 69, 0.4);
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .cute-illustration {
      width: 100%;
      max-width: 150px;
      margin: 0 auto 15px;
      display: block;
    }

    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .error-message {
      color: #FFEB3B;
      font-style: italic;
    }

    /* Styles pour les cartes de pivot circulaires */
    .pivot-card {
      background: white;
      border-radius: 50%;
      width: 120px;
      height: 120px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      margin: 0 auto;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transition: all 0.3s;
      cursor: pointer;
      border: 3px solid var(--primary-color);
      text-decoration: none;
      color: var(--dark-color);
      position: relative;
    }

    .pivot-card:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 25px rgba(0,0,0,0.15);
      border-color: var(--secondary-color);
    }

    .pivot-card i {
      font-size: 2rem;
      margin-bottom: 10px;
      color: var(--primary-color);
    }

    .pivot-card .pivot-name {
      font-weight: 600;
      text-align: center;
    }

    .pivots-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 20px;
      margin-top: 15px;
    }

    /* Style pour les cartes de pivot actives */
    .pivot-card.active {
      background-color: var(--primary-color);
      color: white;
    }

    .pivot-card.active i {
      color: white;
    }

    .panel-actions {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .delete-checkbox {
      position: absolute;
      top: 5px;
      right: 5px;
      width: 20px;
      height: 20px;
      z-index: 1;
      display: none;
    }

    .pivot-card.selected {
      border-color: #ff6b6b;
    }

    .delete-mode .pivot-card {
      border: 3px dashed #ccc;
    }

    .delete-mode .pivot-card.selected {
      border: 3px solid #ff6b6b;
    }

    .delete-mode .delete-checkbox {
      display: block;
    }

    .delete-mode .pivot-card:hover {
      transform: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }
    .sidebar {
        background-color: white;
        border-radius: 15px;
        padding: 10px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        height: 140vh; /* Prend toute la hauteur de la fen√™tre */
        position: sticky; /* Permet de garder la sidebar fixe lors du d√©filement */
        top: 0; /* Positionne en haut de la fen√™tre */
    }

    /* Pour le conteneur principal */
    .container-fluid {
        padding-left: 0; /* Supprime le padding gauche pour utiliser tout l'espace */
        padding-right: 0; /* Supprime le padding droit */
    }

    .row {
        margin-left: 0; /* Supprime les marges pour utiliser tout l'espace */
        margin-right: 0;
    }

    /* Pour la colonne de la sidebar */
    .col-md-3 {
        padding-left: 0; /* Supprime le padding gauche */
        padding-right: 0; /* Supprime le padding droit */
    }

/* pour changer le cercle de pivot en rouge si probl√®me*/
    .pivot-card.probleme {
  border: 2px solid #dc3545 !important;
  box-shadow: 0 0 10px rgba(220, 53, 69, 0.6);
}

/* Styles pour l'ic√¥ne de notification */
.notification-icon {
  position: fixed;
  top: 20px;
  right: 20px;
  width: 45px;
  height: 45px;
  background-color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
  cursor: pointer;
  z-index: 1000;
  transition: all 0.3s ease;
}

.notification-icon:hover {
  transform: scale(1.1);
  box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}

.notification-icon i {
  font-size: 1.5rem;
  color: var(--dark-color);
}

.notification-badge {
  position: absolute;
  top: -5px;
  right: -5px;
  width: 20px;
  height: 20px;
  background-color: #dc3545;
  color: white;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0.75rem;
  font-weight: bold;
  border: 2px solid white;
}

.notification-panel {
  position: fixed;
  top: 75px;
  right: 20px;
  width: 350px;
  max-height: 400px;
  background-color: white;
  border-radius: 10px;
  box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
  z-index: 1000;
  overflow-y: auto;
  display: none;
}

.notification-header {
  padding: 15px;
  border-bottom: 1px solid #eee;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.notification-list {
  padding: 0;
  margin: 0;
  list-style: none;
}

.notification-item {
  padding: 12px 15px;
  border-bottom: 1px solid #eee;
  display: flex;
  align-items: flex-start;
  transition: background-color 0.2s;
}

.notification-item:hover {
  background-color: #f8f9fa;
}

.notification-item.unread {
  background-color: #f0f7ff;
}

.notification-item.unread:hover {
  background-color: #e6f2ff;
}

.notification-icon-small {
  width: 35px;
  height: 35px;
  border-radius: 50%;
  background-color: #e9ecef;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 12px;
  flex-shrink: 0;
}

.notification-icon-small i {
  font-size: 1rem;
  color: var(--primary-color);
}

.notification-content {
  flex-grow: 1;
}

.notification-title {
  font-weight: 600;
  margin-bottom: 3px;
  font-size: 0.9rem;
}

.notification-message {
  color: #6c757d;
  font-size: 0.85rem;
  margin-bottom: 3px;
}

.notification-time {
  color: #adb5bd;
  font-size: 0.75rem;
}

.notification-footer {
  padding: 10px 15px;
  text-align: center;
  border-top: 1px solid #eee;
}

.notification-footer a {
  color: var(--primary-color);
  text-decoration: none;
  font-size: 0.9rem;
}

.notification-footer a:hover {
  text-decoration: underline;
}

/* Animation pour la cloche */
@keyframes ring {
  0% { transform: rotate(0); }
  5% { transform: rotate(15deg); }
  10% { transform: rotate(-15deg); }
  15% { transform: rotate(10deg); }
  20% { transform: rotate(-10deg); }
  25% { transform: rotate(5deg); }
  30% { transform: rotate(-5deg); }
  35% { transform: rotate(0); }
  100% { transform: rotate(0); }
}

.ring-animation {
  animation: ring 1.5s ease;
}

/* Animation pour les alertes critiques */
@keyframes pulse-red {
  0% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0.7); }
  70% { box-shadow: 0 0 0 10px rgba(220, 53, 69, 0); }
  100% { box-shadow: 0 0 0 0 rgba(220, 53, 69, 0); }
}

.critical-alert {
  position: relative;
  border-left: 4px solid #dc3545 !important;
}

/* Style pour l'action automatique dans les notifications */
.notification-action {
  background-color: rgba(0, 0, 0, 0.05);
  padding: 5px 8px;
  border-radius: 4px;
  font-size: 0.85rem;
  margin-top: 5px;
}

/* Indicateur d'urgence pour les notifications critiques */
.critical-alert::before {
  content: "URGENT";
  position: absolute;
  top: 5px;
  right: 5px;
  background-color: #dc3545;
  color: white;
  font-size: 0.65rem;
  font-weight: bold;
  padding: 2px 5px;
  border-radius: 3px;
}










  </style>
</head>
<body>
  <div id="customAlert" class="custom-alert alert alert-dismissible fade show" role="alert">
    <span id="alertMessage"></span>
    <button type="button" class="btn-close" onclick="hideAlert()"></button>
  </div>

  <!-- Notification Icon -->
  <div class="notification-icon" id="notificationIcon" onclick="toggleNotifications()">
    <i class="fas fa-bell"></i>
    <div class="notification-badge" id="notificationBadge">3</div>
  </div>

  <!-- Notification Panel -->
  <div class="notification-panel" id="notificationPanel">
    <div class="notification-header">
      <h6 class="mb-0">Notifications</h6>
      <button class="btn btn-sm text-muted" onclick="markAllAsRead()">
        <i class="fas fa-check-double"></i> Tout marquer comme lu
      </button>
    </div>
    <ul class="notification-list" id="notificationList">
      <li class="notification-item unread">
        <div class="notification-icon-small" style="background-color: #ffecb5;">
          <i class="fas fa-exclamation-triangle" style="color: #ffc107;"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">Alerte d'humidit√©</div>
          <div class="notification-message">Niveau d'humidit√© bas d√©tect√© sur Pivot 2</div>
          <div class="notification-time">Il y a 10 minutes</div>
        </div>
      </li>
      <li class="notification-item unread">
        <div class="notification-icon-small" style="background-color: #d4edda;">
          <i class="fas fa-check-circle" style="color: #28a745;"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">T√¢che termin√©e</div>
          <div class="notification-message">Irrigation du Pivot 1 termin√©e avec succ√®s</div>
          <div class="notification-time">Il y a 30 minutes</div>
        </div>
      </li>
      <li class="notification-item unread">
        <div class="notification-icon-small" style="background-color: #f8d7da;">
          <i class="fas fa-times-circle" style="color: #dc3545;"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">Probl√®me technique</div>
          <div class="notification-message">Dysfonctionnement d√©tect√© sur Pivot 3</div>
          <div class="notification-time">Il y a 1 heure</div>
        </div>
      </li>
      <li class="notification-item">
        <div class="notification-icon-small">
          <i class="fas fa-calendar-check"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">Rappel de planification</div>
          <div class="notification-message">Fertilisation pr√©vue demain pour Pivot 4</div>
          <div class="notification-time">Il y a 3 heures</div>
        </div>
      </li>
      <li class="notification-item">
        <div class="notification-icon-small">
          <i class="fas fa-cloud-sun"></i>
        </div>
        <div class="notification-content">
          <div class="notification-title">Alerte m√©t√©o</div>
          <div class="notification-message">Temp√©ratures √©lev√©es pr√©vues pour les 3 prochains jours</div>
          <div class="notification-time">Il y a 5 heures</div>
        </div>
      </li>
    </ul>
    <div class="notification-footer">
      <a href="rapports.html">Voir l'historique complet</a>
    </div>
  </div>

  <!-- Logout Confirmation Modal -->
  <div class="modal fade" id="logoutModal" tabindex="-1" aria-labelledby="logoutModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="logoutModalLabel">Confirmation de d√©connexion</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <p>√ätes-vous s√ªr de vouloir vous d√©connecter ?</p>
          <p class="text-muted small">Vous devrez vous reconnecter pour acc√©der √† nouveau au tableau de bord.</p>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
          <button type="button" class="btn btn-danger" id="confirmLogout">
            <i class="fas fa-sign-out-alt me-2"></i>Se d√©connecter
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="container-fluid">
    <div class="header">
      <h1><i class="fas fa-seedling me-2"></i> <span class="lang-text" data-lang-key="dashboard_title">Tableau de Bord Agricole</span></h1>
      <div class="subtitle">üåµ <span class="lang-text" data-lang-key="region">R√©gion de B√©char - Alg√©rie</span> üåû</div>
    </div>

    <div class="row">
      <!-- Sidebar -->
      <div class="col-md-3">
        <div class="sidebar">
          <div class="text-center mb-4">
            <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" class="cute-illustration rounded-circle border border-3 border-primary" alt="Profil">
            <h5 class="mt-2">Ferme Agricole</h5>
            <p class="text-muted small">B√©char, Alg√©rie</p>
          </div>

          <div class="sidebar-item">
            <a href="#" class="sidebar-link active">
              <i class="fas fa-tachometer-alt sidebar-icon"></i>
              <span class="lang-text" data-lang-key="dashboard">Tableau de Bord</span>
            </a>
          </div>
          <div class="sidebar-item">
            <a href="planification.html" class="sidebar-link">
              <i class="fas fa-tint sidebar-icon"></i>
              <span class="lang-text" data-lang-key="planning">Planification</span>
            </a>
          </div>
          <div class="sidebar-item">
            <a href="rapports.html" class="sidebar-link">
              <i class="fas fa-chart-bar sidebar-icon"></i>
              <span class="lang-text" data-lang-key="reports">Rapports</span>
            </a>
          </div>
          <div class="sidebar-item">
            <a href="ravageurs.html" class="sidebar-link">
              <i class="fas fa-bug sidebar-icon"></i>
              <span class="lang-text" data-lang-key="pests">Alertes Pivots</span>
            </a>
          </div>

          <hr>

          <div class="sidebar-item">
            <a href="profile.html" class="sidebar-link">
              <i class="fas fa-user sidebar-icon"></i>
              <span class="lang-text" data-lang-key="profile">Mon Profil</span>
            </a>
          </div>
          <div class="sidebar-item management-only">
            <a href="users.html" class="sidebar-link">
              <i class="fas fa-users sidebar-icon"></i>
              <span class="lang-text" data-lang-key="user_management">Gestion des Utilisateurs</span>
            </a>
          </div>
          <div class="sidebar-item">
            <a href="settings.html" class="sidebar-link">
              <i class="fas fa-cog sidebar-icon"></i>
              <span class="lang-text" data-lang-key="settings">Param√®tres</span>
            </a>
          </div>
          <div class="sidebar-item">
            <a href="#" class="sidebar-link" id="logoutBtn">
              <i class="fas fa-sign-out-alt sidebar-icon"></i>
              <span class="lang-text" data-lang-key="logout">D√©connexion</span>
            </a>
          </div>

          <div class="mt-3">
            <button class="btn-cute w-100">
              <i class="fas fa-book me-1"></i> <span class="lang-text" data-lang-key="guide">Guide B√©char</span>
            </button>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <div class="col-md-9">
        <ul class="nav nav-tabs" id="dashboardTabs" role="tablist">
          <li class="nav-item" role="presentation">
            <button class="nav-link active" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" type="button" role="tab">
              <i class="fas fa-home me-1"></i> <span class="lang-text" data-lang-key="overview">Vue d'ensemble</span>
            </button>
          </li>
          <li class="nav-item" role="presentation">
            <button class="nav-link" id="pivots-tab" data-bs-toggle="tab" data-bs-target="#pivots" type="button" role="tab">
              <i class="fas fa-tint me-1"></i> <span class="lang-text" data-lang-key="pivots">Pivots</span>
            </button>
          </li>
        </ul>

        <div class="tab-content" id="dashboardTabsContent">
          <!-- Overview Tab -->
          <div class="tab-pane fade show active" id="overview" role="tabpanel">
            <div class="row">
              <div class="col-md-6">
                <div class="panel">
                  <div class="panel-header">
                    <h5 class="panel-title"><i class="fas fa-sensor me-2"></i><span class="lang-text" data-lang-key="real_time_sensors">Capteurs en Temps R√©el</span></h5>
                  </div>
                  <div class="sensor-card">
                    <div class="sensor-item">
                      <div class="sensor-icon"><i class="fas fa-temperature-high"></i></div>
                      <span class="lang-text" data-lang-key="soil_temp">Temp√©rature sol</span>
                      <span class="sensor-value" id="temp">-- ¬∞C</span>
                    </div>
                    <div class="sensor-item">
                      <div class="sensor-icon"><i class="fas fa-tint"></i></div>
                      <span class="lang-text" data-lang-key="soil_humidity">Humidit√© sol</span>
                      <span class="sensor-value" id="humid">-- %</span>
                    </div>
                    <div class="sensor-item">
                      <div class="sensor-icon"><i class="fas fa-water"></i></div>
                      <span class="lang-text" data-lang-key="air_humidity">Humidit√© air</span>
                      <span class="sensor-value" id="humid-air">-- %</span>
                    </div>
                    <div class="sensor-item">
                      <div class="sensor-icon"><i class="fas fa-sun"></i></div>
                      <span class="lang-text" data-lang-key="luminosity">Luminosit√©</span>
                      <span class="sensor-value" id="light">-- lux</span>
                    </div>
                  </div>
                </div>

                <div class="panel">
                  <div class="panel-header d-flex justify-content-between align-items-center">
                    <h5 class="panel-title"><i class="fas fa-info-circle me-2"></i><span class="lang-text" data-lang-key="agricultural_info">Informations Agricoles</span></h5>
                    <div id="seasonIndicator" class="badge bg-info">
                      <i class="fas fa-seedling me-1"></i> Saison: Printemps
                    </div>
                  </div>
                  <div class="info-card">
                    <div class="info-item">
                      <div class="info-icon"><i class="fas fa-seedling"></i></div>
                      <div>
                        <strong class="lang-text" data-lang-key="crops_info">Cultures recommand√©es:</strong>
                        <span id="recommendedCrops">Ma√Øs, Tomates, Luzerne, Tournesol</span>
                      </div>
                    </div>
                    <div class="info-item">
                      <div class="info-icon"><i class="fas fa-tint"></i></div>
                      <div>
                        <strong class="lang-text" data-lang-key="irrigation_info">Irrigation:</strong>
                        <span id="irrigationRecommendation">Mod√©r√©e √† √©lev√©e, selon la culture</span>
                      </div>
                    </div>
                    <div class="info-item">
                      <div class="info-icon"><i class="fas fa-calendar-alt"></i></div>
                      <div>
                        <strong class="lang-text" data-lang-key="season_info">P√©riode de plantation:</strong>
                        <span id="plantingPeriod">Mars √† Mai</span>
                      </div>
                    </div>
                    <div class="info-item">
                      <div class="info-icon"><i class="fas fa-chart-line"></i></div>
                      <div>
                        <strong class="lang-text" data-lang-key="yield_info">Rendement estim√©:</strong>
                        <span id="estimatedYield">8-15 tonnes/ha (selon culture)</span>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="panel">
                  <div class="panel-header">
                    <h5 class="panel-title"><i class="fas fa-cloud-sun me-2"></i><span class="lang-text" data-lang-key="weather_title">M√©t√©o - B√©char</span></h5>
                  </div>
                  <div class="weather-card">
                    <div class="d-flex align-items-center mb-3">
                      <i id="current-weather-icon" class="fas fa-sun weather-icon"></i>
                      <div>
                        <h2 class="mb-0"><span id="current-temp">--</span>¬∞C</h2>
                        <p class="mb-0" id="weather-description">Chargement...</p>
                      </div>
                    </div>

                    <div class="row mb-3">
                      <div class="col-6">
                        <p><i class="fas fa-wind me-2"></i> <span class="lang-text" data-lang-key="wind">Vent:</span> <span id="wind-speed">--</span> km/h</p>
                        <p><i class="fas fa-tint me-2"></i> <span class="lang-text" data-lang-key="humidity">Humidit√©:</span> <span id="humidity">--</span>%</p>
                      </div>
                      <div class="col-6">
                        <p><i class="fas fa-temperature-high me-2"></i> <span class="lang-text" data-lang-key="max_temp">Max:</span> <span id="temp-max">--</span>¬∞C</p>
                        <p><i class="fas fa-temperature-low me-2"></i> <span class="lang-text" data-lang-key="min_temp">Min:</span> <span id="temp-min">--</span>¬∞C</p>
                      </div>
                    </div>

                    <h6 class="mb-3"><span class="lang-text" data-lang-key="forecast_title">Pr√©visions sur 5 jours</span></h6>
                    <div id="forecast-container">
                      <div class="forecast-day">
                        <div class="d-flex align-items-center">
                          <p class="mb-0">--</p>
                          <i class="fas fa-question ms-2"></i>
                        </div>
                        <p class="mb-0">--¬∞C</p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="row">
              <div class="col-md-6">
                <div class="panel">
                  <div class="panel-header">
                    <h5 class="panel-title"><i class="fas fa-map-marked-alt me-2"></i><span class="lang-text" data-lang-key="agricultural_zones">Carte des Zones Agricoles</span></h5>
                  </div>
                  <div class="map-container">
                    <div id="map"></div>
                    <div class="map-overlay">
                      <p class="mb-0">B√©char, Alg√©rie - Zone agricole du Sahara</p>
                    </div>
                  </div>
                </div>
              </div>

              <div class="col-md-6">
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, var(--primary-color) 0%, #7ab992 100%);">
                      <i class="fas fa-tractor fa-2x mb-2"></i>
                      <div class="stats-value">1,250 ha</div>
                      <div class="stats-label"><span class="lang-text" data-lang-key="cultivated_areas">Zones cultiv√©es</span></div>
                      <p class="small mt-2 mb-0">+5.2% depuis l'ann√©e derni√®re</p>
                    </div>
                  </div>

                  <div class="col-md-6 mb-3">
                    <div class="stats-card" style="background: linear-gradient(135deg, var(--secondary-color) 0%, #e8916a 100%);">
                      <i class="fas fa-water fa-2x mb-2"></i>
                      <div class="stats-value">2,450 m¬≥</div>
                      <div class="stats-label"><span class="lang-text" data-lang-key="water_consumption">Consommation d'eau</span></div>
                      <p class="small mt-2 mb-0">-3.1% depuis le mois dernier</p>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="stats-card" style="background: linear-gradient(135deg, var(--accent-color) 0%, #5a7d82 100%);">
                      <i class="fas fa-seedling fa-2x mb-2"></i>
                      <div class="stats-value">12 t/ha</div>
                      <div class="stats-label"><span class="lang-text" data-lang-key="average_yield">Rendement moyen</span></div>
                      <p class="small mt-2 mb-0">+2.4% cette saison</p>
                    </div>
                  </div>

                  <div class="col-md-6">
                    <div class="stats-card" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);">
                      <i class="fas fa-bolt fa-2x mb-2"></i>
                      <div class="stats-value">85%</div>
                      <div class="stats-label"><span class="lang-text" data-lang-key="completed_tasks">T√¢ches compl√©t√©es</span></div>
                      <p class="small mt-2 mb-0">3 t√¢ches restantes</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Pivots Tab -->
          <div class="tab-pane fade" id="pivots" role="tabpanel">
            <div class="panel">
              <div class="panel-header">
                <h5 class="panel-title"><i class="fas fa-tint me-2"></i><span class="lang-text" data-lang-key="irrigation_pivots">Pivots d'Irrigation</span></h5>
                <div>
                  <button class="btn-cute management-only pivot-management" onclick="toggleDeleteMode()" id="deleteModeBtn">
                    <i class="fas fa-trash-alt me-1"></i> <span class="lang-text" data-lang-key="delete_pivot">Supprimer</span>
                  </button>
                  <button class="btn-cute management-only pivot-management" onclick="addNewPivot()">
                    <i class="fas fa-plus me-1"></i> <span class="lang-text" data-lang-key="add_pivot">Ajouter</span>
                  </button>
                  <button class="btn-cute" onclick="window.location.href='planification.html'">
                    <i class="fas fa-calendar-alt me-1"></i> <span class="lang-text" data-lang-key="plan_pivot">Planifier</span>
                  </button>
                </div>
              </div>
              <div class="pivots-container" id="pivotsContainer">
                <!-- Les cartes de pivot seront ajout√©es ici dynamiquement -->
              </div>
              <div class="panel-actions" id="deleteActions" style="display: none;">
                <button class="btn-danger-cute management-only pivot-management" onclick="deleteSelectedPivots()">
                  <i class="fas fa-trash me-1"></i> <span class="lang-text" data-lang-key="delete">Supprimer les s√©lectionn√©s</span>
                </button>
                <button class="btn-cute" onclick="cancelDeleteMode()">
                  <i class="fas fa-times me-1"></i> <span class="lang-text" data-lang-key="cancel">Annuler</span>
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/main.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.11.3/locales/fr.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="js/auth.js"></script>
  <script src="js/language.js"></script>

  <script>
    let pivots = ['Pivot 1', 'Pivot 2', 'Pivot 3', 'Pivot 4'];
    let pivotData = []; // Will store the detailed pivot data from the API
    let deleteMode = false;
    let selectedPivots = [];

    // Seuils pour les capteurs agricoles
    const SENSOR_THRESHOLDS = {
      temperature: {
        soil: { min: 10, max: 35, critical_min: 5, critical_max: 40 },
        air: { min: 5, max: 40, critical_min: 0, critical_max: 45 }
      },
      humidity: {
        soil: { min: 20, max: 80, critical_min: 10, critical_max: 90 },
        air: { min: 30, max: 80, critical_min: 20, critical_max: 90 }
      },
      light: { min: 5000, max: 80000, critical_min: 2000, critical_max: 100000 }
    };

    // D√©finition des saisons pour la r√©gion de B√©char
    const SEASONS = {
      'Printemps': { months: [3, 4, 5], tempRange: [15, 30], rainfall: 'Mod√©r√©e' },
      '√ât√©': { months: [6, 7, 8], tempRange: [30, 45], rainfall: 'Faible' },
      'Automne': { months: [9, 10, 11], tempRange: [15, 30], rainfall: 'Mod√©r√©e' },
      'Hiver': { months: [12, 1, 2], tempRange: [5, 20], rainfall: '√âlev√©e' }
    };

    // Fonction pour obtenir la saison actuelle
    function getCurrentSeason() {
      const currentMonth = new Date().getMonth() + 1; // getMonth() retourne 0-11
      for (const [season, data] of Object.entries(SEASONS)) {
        if (data.months.includes(currentMonth)) {
          return { name: season, data: data };
        }
      }
      return { name: 'Printemps', data: SEASONS['Printemps'] }; // Par d√©faut
    }

    // Types de cultures adapt√©es aux pivots d'irrigation et leurs besoins sp√©cifiques
    const CROP_REQUIREMENTS = {
      // C√©r√©ales
      'Ma√Øs': {
        type: 'C√©r√©ale',
        temperature: { soil: { min: 15, max: 35 }, air: { min: 10, max: 38 } },
        humidity: { soil: { min: 40, max: 70 }, air: { min: 40, max: 80 } },
        seasons: ['Printemps', '√ât√©'],
        cycleLength: '90-120 jours',
        waterNeeds: '√âlev√©s',
        description: 'Id√©al pour les pivots, n√©cessite une irrigation r√©guli√®re'
      },
      'Bl√© tendre': {
        type: 'C√©r√©ale',
        temperature: { soil: { min: 5, max: 30 }, air: { min: 5, max: 32 } },
        humidity: { soil: { min: 35, max: 60 }, air: { min: 35, max: 70 } },
        seasons: ['Automne', 'Hiver'],
        cycleLength: '120-150 jours',
        waterNeeds: 'Mod√©r√©s',
        description: 'Bien adapt√© aux conditions semi-arides avec irrigation'
      },
      'Orge': {
        type: 'C√©r√©ale',
        temperature: { soil: { min: 5, max: 30 }, air: { min: 5, max: 30 } },
        humidity: { soil: { min: 30, max: 60 }, air: { min: 30, max: 70 } },
        seasons: ['Automne', 'Hiver'],
        cycleLength: '90-120 jours',
        waterNeeds: 'Mod√©r√©s',
        description: 'Plus r√©sistant √† la s√©cheresse que le bl√©'
      },
      'Sorgho': {
        type: 'C√©r√©ale',
        temperature: { soil: { min: 18, max: 40 }, air: { min: 15, max: 42 } },
        humidity: { soil: { min: 30, max: 60 }, air: { min: 30, max: 70 } },
        seasons: ['Printemps', '√ât√©'],
        cycleLength: '90-120 jours',
        waterNeeds: 'Mod√©r√©s',
        description: 'Tr√®s r√©sistant √† la chaleur et √† la s√©cheresse'
      },

      // L√©gumes
      'Tomates': {
        type: 'L√©gume',
        temperature: { soil: { min: 18, max: 32 }, air: { min: 15, max: 35 } },
        humidity: { soil: { min: 50, max: 75 }, air: { min: 50, max: 80 } },
        seasons: ['Printemps', '√ât√©'],
        cycleLength: '70-90 jours',
        waterNeeds: '√âlev√©s',
        description: 'N√©cessite une irrigation r√©guli√®re et un bon drainage'
      },
      'Oignons': {
        type: 'L√©gume',
        temperature: { soil: { min: 10, max: 30 }, air: { min: 10, max: 35 } },
        humidity: { soil: { min: 40, max: 70 }, air: { min: 40, max: 70 } },
        seasons: ['Automne', 'Hiver', 'Printemps'],
        cycleLength: '120-150 jours',
        waterNeeds: 'Mod√©r√©s',
        description: 'Bien adapt√© aux conditions arides avec irrigation'
      },
      'Pommes de terre': {
        type: 'L√©gume',
        temperature: { soil: { min: 10, max: 25 }, air: { min: 10, max: 30 } },
        humidity: { soil: { min: 45, max: 75 }, air: { min: 40, max: 70 } },
        seasons: ['Automne', 'Hiver'],
        cycleLength: '90-120 jours',
        waterNeeds: 'Mod√©r√©s √† √©lev√©s',
        description: 'N√©cessite une irrigation r√©guli√®re et un sol bien drain√©'
      },
      'Carottes': {
        type: 'L√©gume',
        temperature: { soil: { min: 10, max: 25 }, air: { min: 10, max: 30 } },
        humidity: { soil: { min: 45, max: 70 }, air: { min: 40, max: 70 } },
        seasons: ['Automne', 'Hiver', 'Printemps'],
        cycleLength: '70-90 jours',
        waterNeeds: 'Mod√©r√©s',
        description: 'Id√©al pour les sols l√©gers et bien drain√©s'
      },

      // Fourrages
      'Luzerne': {
        type: 'Fourrage',
        temperature: { soil: { min: 10, max: 35 }, air: { min: 10, max: 40 } },
        humidity: { soil: { min: 40, max: 70 }, air: { min: 30, max: 70 } },
        seasons: ['Printemps', '√ât√©', 'Automne'],
        cycleLength: 'P√©renne (3-5 ans)',
        waterNeeds: '√âlev√©s',
        description: 'Excellente culture fourrag√®re pour les pivots d\'irrigation'
      },
      'Tr√®fle': {
        type: 'Fourrage',
        temperature: { soil: { min: 8, max: 30 }, air: { min: 8, max: 35 } },
        humidity: { soil: { min: 45, max: 75 }, air: { min: 40, max: 75 } },
        seasons: ['Automne', 'Hiver', 'Printemps'],
        cycleLength: 'P√©renne (2-3 ans)',
        waterNeeds: 'Mod√©r√©s √† √©lev√©s',
        description: 'Fixe l\'azote dans le sol, am√©liore la fertilit√©'
      },

      // Cultures industrielles
      'Tournesol': {
        type: 'Industrielle',
        temperature: { soil: { min: 15, max: 35 }, air: { min: 15, max: 40 } },
        humidity: { soil: { min: 35, max: 65 }, air: { min: 30, max: 70 } },
        seasons: ['Printemps', '√ât√©'],
        cycleLength: '90-120 jours',
        waterNeeds: 'Mod√©r√©s',
        description: 'R√©sistant √† la s√©cheresse, adapt√© aux conditions semi-arides'
      },
      'Coton': {
        type: 'Industrielle',
        temperature: { soil: { min: 18, max: 40 }, air: { min: 18, max: 45 } },
        humidity: { soil: { min: 40, max: 70 }, air: { min: 30, max: 60 } },
        seasons: ['Printemps', '√ât√©'],
        cycleLength: '150-180 jours',
        waterNeeds: '√âlev√©s',
        description: 'N√©cessite beaucoup d\'eau mais tol√®re bien la chaleur'
      }
    };

    document.addEventListener('DOMContentLoaded', function() {
      // Check if user is logged in
      checkUserAuthentication();

      // Load language
      loadLanguage();

      // Initialize logout functionality
      initLogout();

      // Initialize notifications
      initNotifications();

      // Initialisation de la carte
      var map = L.map('map').setView([31.6167, -2.2167], 12);

      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);

      // Ajout d'un marqueur pour B√©char
      L.marker([31.6167, -2.2167]).addTo(map)
        .bindPopup('<b>B√©char</b><br>Zone agricole principale')
        .openPopup();

      // Ajout d'une zone agricole
      L.circle([31.6167, -2.2167], {
        color: '#4CAF50',
        fillColor: '#4CAF50',
        fillOpacity: 0.2,
        radius: 2000
      }).addTo(map).bindPopup('Zone agricole de B√©char');

      // Charger les pivots
      loadPivots();

      // Mettre √† jour les informations saisonni√®res
      updateSeasonalInfo();

      // Fonction pour mettre √† jour les informations saisonni√®res
      function updateSeasonalInfo() {
        const currentSeason = getCurrentSeason();

        // Mettre √† jour l'indicateur de saison
        const seasonIndicator = document.getElementById('seasonIndicator');
        const seasonIcon = currentSeason.name === 'Printemps' ? 'seedling' :
                          currentSeason.name === '√ât√©' ? 'sun' :
                          currentSeason.name === 'Automne' ? 'leaf' : 'snowflake';

        seasonIndicator.innerHTML = `<i class="fas fa-${seasonIcon} me-1"></i> Saison: ${currentSeason.name}`;

        // D√©finir la couleur de l'indicateur selon la saison
        seasonIndicator.className = 'badge ' +
          (currentSeason.name === 'Printemps' ? 'bg-success' :
           currentSeason.name === '√ât√©' ? 'bg-danger' :
           currentSeason.name === 'Automne' ? 'bg-warning' : 'bg-info');

        // Trouver les cultures recommand√©es pour cette saison
        const recommendedCropsForSeason = Object.entries(CROP_REQUIREMENTS)
          .filter(([_, data]) => data.seasons && data.seasons.includes(currentSeason.name))
          .map(([crop, _]) => crop);

        // Limiter √† 4 cultures maximum pour l'affichage
        const topRecommendedCrops = recommendedCropsForSeason.slice(0, 4).join(', ');

        // Mettre √† jour les recommandations
        document.getElementById('recommendedCrops').textContent = topRecommendedCrops;

        // Mettre √† jour les recommandations d'irrigation selon la saison
        const irrigationRecommendation =
          currentSeason.name === 'Printemps' ? 'Mod√©r√©e √† √©lev√©e, selon la culture' :
          currentSeason.name === '√ât√©' ? '√âlev√©e, irrigation quotidienne recommand√©e' :
          currentSeason.name === 'Automne' ? 'Mod√©r√©e, selon les pr√©cipitations' :
          'Faible √† mod√©r√©e, surveiller l\'humidit√© du sol';

        document.getElementById('irrigationRecommendation').textContent = irrigationRecommendation;

        // Mettre √† jour la p√©riode de plantation
        const plantingPeriod =
          currentSeason.name === 'Printemps' ? 'Mars √† Mai' :
          currentSeason.name === '√ât√©' ? 'Juin √† Ao√ªt (cultures r√©sistantes)' :
          currentSeason.name === 'Automne' ? 'Septembre √† Novembre' :
          'D√©cembre √† F√©vrier (serres uniquement)';

        document.getElementById('plantingPeriod').textContent = plantingPeriod;

        // Mettre √† jour le rendement estim√©
        const estimatedYield =
          currentSeason.name === 'Printemps' ? '8-15 tonnes/ha (selon culture)' :
          currentSeason.name === '√ât√©' ? '10-18 tonnes/ha (cultures adapt√©es)' :
          currentSeason.name === 'Automne' ? '6-12 tonnes/ha (c√©r√©ales)' :
          '4-8 tonnes/ha (cultures d\'hiver)';

        document.getElementById('estimatedYield').textContent = estimatedYield;
      }

      // Fonction pour r√©cup√©rer les donn√©es m√©t√©o
      async function fetchWeatherData() {
        const apiKey = 'a162c938e49d47143cfe359703f7f716';
        const lat = 31.6167;
        const lon = -2.2167;

        try {
          // Donn√©es actuelles
          const currentResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=fr&appid=${apiKey}`
          );
          const currentData = await currentResponse.json();

          // Pr√©visions
          const forecastResponse = await fetch(
            `https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=fr&appid=${apiKey}`
          );
          const forecastData = await forecastResponse.json();

          updateCurrentWeather(currentData);
          updateForecast(forecastData);

        } catch (error) {
          console.error('Erreur:', error);
          document.getElementById('weather-description').textContent = 'Donn√©es non disponibles';
          document.getElementById('weather-description').className = 'error-message';
        }
      }

      function updateCurrentWeather(data) {
        document.getElementById('current-temp').textContent = Math.round(data.main.temp);
        document.getElementById('weather-description').textContent =
          data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1);
        document.getElementById('wind-speed').textContent = (data.wind.speed * 3.6).toFixed(1);
        document.getElementById('humidity').textContent = data.main.humidity;
        document.getElementById('temp-max').textContent = Math.round(data.main.temp_max);
        document.getElementById('temp-min').textContent = Math.round(data.main.temp_min);

        const weatherIcon = document.getElementById('current-weather-icon');
        weatherIcon.className = getWeatherIconClass(data.weather[0].icon) + ' weather-icon';
      }

      function updateForecast(data) {
        const forecastContainer = document.getElementById('forecast-container');
        forecastContainer.innerHTML = '';

        const dailyForecasts = [];
        const daysAdded = new Set();

        data.list.forEach(forecast => {
          const date = new Date(forecast.dt * 1000);
          const dayKey = date.toLocaleDateString('fr-FR', { weekday: 'short' });

          if (!daysAdded.has(dayKey) && daysAdded.size < 5) {
            daysAdded.add(dayKey);
            dailyForecasts.push({
              day: dayKey,
              temp: Math.round(forecast.main.temp),
              icon: forecast.weather[0].icon
            });
          }
        });

        dailyForecasts.forEach(day => {
          const dayElement = document.createElement('div');
          dayElement.className = 'forecast-day';
          dayElement.innerHTML = `
            <div class="d-flex align-items-center">
              <p class="mb-0">${day.day}</p>
              <i class="${getWeatherIconClass(day.icon)} ms-2"></i>
            </div>
            <p class="mb-0">${day.temp}¬∞C</p>
          `;
          forecastContainer.appendChild(dayElement);
        });
      }

      function getWeatherIconClass(weatherCode) {
        const iconMap = {
          '01d': 'fas fa-sun',
          '01n': 'fas fa-moon',
          '02d': 'fas fa-cloud-sun',
          '02n': 'fas fa-cloud-moon',
          '03d': 'fas fa-cloud',
          '03n': 'fas fa-cloud',
          '04d': 'fas fa-cloud',
          '04n': 'fas fa-cloud',
          '09d': 'fas fa-cloud-rain',
          '09n': 'fas fa-cloud-rain',
          '10d': 'fas fa-cloud-showers-heavy',
          '10n': 'fas fa-cloud-showers-heavy',
          '11d': 'fas fa-bolt',
          '11n': 'fas fa-bolt',
          '13d': 'fas fa-snowflake',
          '13n': 'fas fa-snowflake',
          '50d': 'fas fa-smog',
          '50n': 'fas fa-smog'
        };

        return iconMap[weatherCode] || 'fas fa-question';
      }

      fetchWeatherData();
      setInterval(fetchWeatherData, 3600000); // Mettre √† jour toutes les heures

      // Variables pour stocker les valeurs des capteurs
      let currentSensorValues = {
        temperature: { soil: 0, air: 0 },
        humidity: { soil: 0, air: 0 },
        light: 0
      };

      // Fonction pour les capteurs avec v√©rification des seuils
      function updateFakeSensorData() {
        // G√©n√©rer des valeurs al√©atoires pour les capteurs
        // Parfois g√©n√©rer des valeurs extr√™mes pour simuler des conditions critiques
        const criticalChance = Math.random() < 0.15; // 15% de chance d'avoir une valeur critique

        let temp, hum, humAir, light;

        if (criticalChance) {
          // G√©n√©rer une valeur critique pour l'un des capteurs
          const criticalSensor = Math.floor(Math.random() * 4); // 0-3 pour choisir quel capteur sera critique

          switch(criticalSensor) {
            case 0: // Temp√©rature du sol critique
              temp = Math.random() < 0.5 ?
                (SENSOR_THRESHOLDS.temperature.soil.critical_min - Math.random() * 5).toFixed(1) : // Trop basse
                (SENSOR_THRESHOLDS.temperature.soil.critical_max + Math.random() * 5).toFixed(1);  // Trop haute
              hum = (30 + Math.random() * 20).toFixed(1);
              humAir = (40 + Math.random() * 30).toFixed(1);
              light = (10000 + Math.random() * 50000).toFixed(0);
              break;
            case 1: // Humidit√© du sol critique
              temp = (20 + Math.random() * 10).toFixed(1);
              hum = Math.random() < 0.5 ?
                (SENSOR_THRESHOLDS.humidity.soil.critical_min - Math.random() * 5).toFixed(1) : // Trop basse
                (SENSOR_THRESHOLDS.humidity.soil.critical_max + Math.random() * 5).toFixed(1);  // Trop haute
              humAir = (40 + Math.random() * 30).toFixed(1);
              light = (10000 + Math.random() * 50000).toFixed(0);
              break;
            case 2: // Humidit√© de l'air critique
              temp = (20 + Math.random() * 10).toFixed(1);
              hum = (30 + Math.random() * 20).toFixed(1);
              humAir = Math.random() < 0.5 ?
                (SENSOR_THRESHOLDS.humidity.air.critical_min - Math.random() * 5).toFixed(1) : // Trop basse
                (SENSOR_THRESHOLDS.humidity.air.critical_max + Math.random() * 5).toFixed(1);  // Trop haute
              light = (10000 + Math.random() * 50000).toFixed(0);
              break;
            case 3: // Luminosit√© critique
              temp = (20 + Math.random() * 10).toFixed(1);
              hum = (30 + Math.random() * 20).toFixed(1);
              humAir = (40 + Math.random() * 30).toFixed(1);
              light = Math.random() < 0.5 ?
                (SENSOR_THRESHOLDS.light.critical_min - Math.random() * 1000).toFixed(0) : // Trop basse
                (SENSOR_THRESHOLDS.light.critical_max + Math.random() * 20000).toFixed(0); // Trop haute
              break;
          }
        } else {
          // Valeurs normales
          temp = (20 + Math.random() * 10).toFixed(1);
          hum = (30 + Math.random() * 20).toFixed(1);
          humAir = (40 + Math.random() * 30).toFixed(1);
          light = (10000 + Math.random() * 50000).toFixed(0);
        }

        // Mettre √† jour les valeurs actuelles
        currentSensorValues.temperature.soil = parseFloat(temp);
        currentSensorValues.humidity.soil = parseFloat(hum);
        currentSensorValues.humidity.air = parseFloat(humAir);
        currentSensorValues.light = parseInt(light);

        // Afficher les valeurs dans l'interface
        document.getElementById("temp").innerText = temp + " ¬∞C";
        document.getElementById("humid").innerText = hum + " %";
        document.getElementById("humid-air").innerText = humAir + " %";
        document.getElementById("light").innerText = light + " lux";

        // V√©rifier les seuils et cr√©er des alertes si n√©cessaire
        checkSensorThresholds();
      }

      // Fonction pour v√©rifier les seuils des capteurs et cr√©er des alertes
      function checkSensorThresholds() {
        // S√©lectionner un pivot al√©atoire pour l'alerte
        const randomPivotIndex = Math.floor(Math.random() * pivots.length);
        const randomPivot = pivots[randomPivotIndex];

        // R√©cup√©rer le type de culture pour ce pivot (simul√©)
        const pivotDetails = JSON.parse(localStorage.getItem('pivotDetails')) || {};
        const pivotCrop = pivotDetails[randomPivot]?.crop || 'Ma√Øs'; // Par d√©faut Ma√Øs si non sp√©cifi√©

        // V√©rifier la temp√©rature du sol
        if (checkCriticalValue(currentSensorValues.temperature.soil,
                              SENSOR_THRESHOLDS.temperature.soil,
                              CROP_REQUIREMENTS[pivotCrop]?.temperature?.soil)) {

          const isTooHigh = currentSensorValues.temperature.soil > SENSOR_THRESHOLDS.temperature.soil.max;

          // Cr√©er une alerte
          createAlert({
            type: 'critical',
            title: 'Alerte critique de temp√©rature',
            message: `Temp√©rature du sol ${isTooHigh ? 'trop √©lev√©e' : 'trop basse'} (${currentSensorValues.temperature.soil}¬∞C) sur ${randomPivot}`,
            icon: 'temperature-high',
            iconColor: '#dc3545',
            iconBg: '#f8d7da',
            pivot: randomPivot,
            action: isTooHigh ? 'start_irrigation' : 'create_task',
            actionMessage: isTooHigh ?
              `Irrigation automatique d√©marr√©e sur ${randomPivot}` :
              `T√¢che urgente cr√©√©e: V√©rifier le syst√®me de chauffage sur ${randomPivot}`
          });

          // Mettre √† jour l'√©tat du pivot
          updatePivotState(randomPivot, 'probleme');

          return; // Une seule alerte √† la fois
        }

        // V√©rifier l'humidit√© du sol
        if (checkCriticalValue(currentSensorValues.humidity.soil,
                              SENSOR_THRESHOLDS.humidity.soil,
                              CROP_REQUIREMENTS[pivotCrop]?.humidity?.soil)) {

          const isTooHigh = currentSensorValues.humidity.soil > SENSOR_THRESHOLDS.humidity.soil.max;

          // Cr√©er une alerte
          createAlert({
            type: isTooHigh ? 'warning' : 'critical',
            title: `Alerte ${isTooHigh ? 'de' : 'critique d\''}humidit√©`,
            message: `Humidit√© du sol ${isTooHigh ? 'trop √©lev√©e' : 'trop basse'} (${currentSensorValues.humidity.soil}%) sur ${randomPivot}`,
            icon: 'tint',
            iconColor: isTooHigh ? '#ffc107' : '#dc3545',
            iconBg: isTooHigh ? '#fff3cd' : '#f8d7da',
            pivot: randomPivot,
            action: isTooHigh ? 'stop_irrigation' : 'start_irrigation',
            actionMessage: isTooHigh ?
              `Irrigation automatiquement arr√™t√©e sur ${randomPivot}` :
              `Irrigation automatique d√©marr√©e sur ${randomPivot}`
          });

          // Mettre √† jour l'√©tat du pivot si critique
          if (!isTooHigh) {
            updatePivotState(randomPivot, 'probleme');
          }

          return; // Une seule alerte √† la fois
        }

        // V√©rifier l'humidit√© de l'air
        if (checkCriticalValue(currentSensorValues.humidity.air,
                              SENSOR_THRESHOLDS.humidity.air,
                              CROP_REQUIREMENTS[pivotCrop]?.humidity?.air)) {

          const isTooHigh = currentSensorValues.humidity.air > SENSOR_THRESHOLDS.humidity.air.max;

          // Cr√©er une alerte
          createAlert({
            type: 'warning',
            title: 'Alerte d\'humidit√© de l\'air',
            message: `Humidit√© de l'air ${isTooHigh ? 'trop √©lev√©e' : 'trop basse'} (${currentSensorValues.humidity.air}%) autour de ${randomPivot}`,
            icon: 'cloud-rain',
            iconColor: '#ffc107',
            iconBg: '#fff3cd',
            pivot: randomPivot,
            action: 'create_task',
            actionMessage: `T√¢che cr√©√©e: ${isTooHigh ? 'Am√©liorer la ventilation' : 'V√©rifier le syst√®me d\'humidification'} autour de ${randomPivot}`
          });

          return; // Une seule alerte √† la fois
        }

        // V√©rifier la luminosit√©
        if (checkCriticalValue(currentSensorValues.light, SENSOR_THRESHOLDS.light)) {

          const isTooHigh = currentSensorValues.light > SENSOR_THRESHOLDS.light.max;

          // Cr√©er une alerte
          createAlert({
            type: 'info',
            title: 'Information de luminosit√©',
            message: `Luminosit√© ${isTooHigh ? 'tr√®s √©lev√©e' : 'faible'} (${currentSensorValues.light} lux) sur la zone de ${randomPivot}`,
            icon: 'sun',
            iconColor: '#0dcaf0',
            iconBg: '#d1ecf1',
            pivot: randomPivot,
            action: 'create_task',
            actionMessage: isTooHigh ?
              `Conseil: Envisager une protection solaire pour ${randomPivot}` :
              `Conseil: Surveiller la croissance des plantes sur ${randomPivot}`
          });
        }
      }

      // Fonction pour v√©rifier si une valeur est critique
      function checkCriticalValue(value, thresholds, cropRequirements = null) {
        // Si des exigences sp√©cifiques √† la culture sont disponibles, les utiliser
        const min = cropRequirements?.min || thresholds.min;
        const max = cropRequirements?.max || thresholds.max;
        const critical_min = thresholds.critical_min;
        const critical_max = thresholds.critical_max;

        // V√©rifier si la valeur est en dehors des seuils critiques
        return value <= critical_min || value >= critical_max || value <= min || value >= max;
      }

      // Fonction pour cr√©er une alerte et prendre une action automatique
      function createAlert(alertData) {
        // Cr√©er la notification
        const notificationList = document.getElementById('notificationList');
        const newNotification = document.createElement('li');
        newNotification.className = 'notification-item unread';

        if (alertData.type === 'critical') {
          newNotification.classList.add('critical-alert');
          // Ajouter une animation de pulsation rouge pour les alertes critiques
          newNotification.style.animation = 'pulse-red 2s infinite';
        }

        newNotification.innerHTML = `
          <div class="notification-icon-small" style="background-color: ${alertData.iconBg};">
            <i class="fas fa-${alertData.icon}" style="color: ${alertData.iconColor};"></i>
          </div>
          <div class="notification-content">
            <div class="notification-title">${alertData.title}</div>
            <div class="notification-message">${alertData.message}</div>
            <div class="notification-time">√Ä l'instant</div>
            ${alertData.action ? `<div class="notification-action" style="color: ${alertData.iconColor}; font-weight: bold; margin-top: 5px;">
              <i class="fas fa-${alertData.action.includes('irrigation') ? 'tint' : 'tasks'}"></i> ${alertData.actionMessage}
            </div>` : ''}
          </div>
        `;

        // Ajouter au d√©but de la liste
        notificationList.insertBefore(newNotification, notificationList.firstChild);

        // Mettre √† jour le compteur de notifications
        const badge = document.getElementById('notificationBadge');
        badge.textContent = parseInt(badge.textContent) + 1;

        // Animer l'ic√¥ne de notification
        const icon = document.getElementById('notificationIcon').querySelector('i');
        icon.classList.add('ring-animation');
        setTimeout(() => {
          icon.classList.remove('ring-animation');
        }, 1500);

        // Afficher une alerte visuelle pour les notifications critiques
        if (alertData.type === 'critical') {
          showCriticalAlert(alertData);
        }

        // G√©n√©rer un ID unique pour l'alerte si elle n'en a pas d√©j√† un
        if (!alertData.id) {
          alertData.id = Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        // Sauvegarder l'alerte dans l'historique
        saveAlertToHistory(alertData);

        // Prendre une action automatique en fonction du type d'alerte
        takeAutomaticAction(alertData);

        // Limiter le nombre de notifications √† 10
        const items = notificationList.querySelectorAll('.notification-item');
        if (items.length > 10) {
          notificationList.removeChild(items[items.length - 1]);
        }
      }

      // Fonction pour sauvegarder l'alerte dans l'historique
      function saveAlertToHistory(alertData) {
        // R√©cup√©rer les alertes existantes ou cr√©er un tableau vide
        const alerts = JSON.parse(localStorage.getItem('agricultureAlerts')) || [];

        // G√©n√©rer un ID unique pour l'alerte si elle n'en a pas d√©j√† un
        const alertId = alertData.id || Date.now().toString(36) + Math.random().toString(36).substr(2);

        // Cr√©er un objet alerte
        const newAlert = {
          id: alertId,
          title: alertData.title,
          message: alertData.message,
          type: alertData.type, // 'critical', 'warning', 'info'
          pivot: alertData.pivot,
          icon: alertData.icon,
          iconColor: alertData.iconColor,
          iconBg: alertData.iconBg,
          action: alertData.action,
          actionMessage: alertData.actionMessage,
          date: new Date().toISOString(),
          createTask: alertData.action === 'create_task',
          taskCreated: false,
          taskId: null
        };

        // Ajouter la nouvelle alerte au d√©but du tableau
        alerts.unshift(newAlert);

        // Limiter le nombre d'alertes stock√©es √† 100
        if (alerts.length > 100) {
          alerts.pop();
        }

        // Sauvegarder le tableau mis √† jour
        localStorage.setItem('agricultureAlerts', JSON.stringify(alerts));

        // Mettre √† jour l'ID de l'alerte dans l'objet original pour r√©f√©rence future
        alertData.id = alertId;

        return alertId;
      }

      // Fonction pour afficher une alerte critique
      function showCriticalAlert(alertData) {
        const alertMessage = `‚ö†Ô∏è ALERTE CRITIQUE: ${alertData.message}`;

        // Utiliser l'alerte personnalis√©e existante
        const customAlert = document.getElementById('customAlert');
        const alertMessageElement = document.getElementById('alertMessage');

        customAlert.className = 'custom-alert alert alert-danger-custom alert-dismissible fade show';
        alertMessageElement.textContent = alertMessage;
        customAlert.style.display = 'block';

        // Ajouter une animation de pulsation
        customAlert.style.animation = 'pulse-red 2s infinite';

        // Masquer l'alerte apr√®s 10 secondes
        setTimeout(() => {
          customAlert.style.display = 'none';
          customAlert.style.animation = '';
        }, 10000);
      }

      // Fonction pour prendre une action automatique
      function takeAutomaticAction(alertData) {
        switch(alertData.action) {
          case 'start_irrigation':
            // Simuler le d√©marrage de l'irrigation
            localStorage.setItem(`irrigation_${alertData.pivot}`, 'active');
            console.log(`Irrigation automatiquement d√©marr√©e sur ${alertData.pivot}`);
            break;

          case 'stop_irrigation':
            // Simuler l'arr√™t de l'irrigation
            localStorage.setItem(`irrigation_${alertData.pivot}`, 'desactive');
            console.log(`Irrigation automatiquement arr√™t√©e sur ${alertData.pivot}`);
            break;

          case 'create_task':
            // S'assurer que l'alerte a un ID
            if (!alertData.id) {
              console.error("L'alerte n'a pas d'ID lors de la cr√©ation de t√¢che");
              return;
            }

            // Simuler la cr√©ation d'une t√¢che urgente
            const taskId = Date.now().toString(36) + Math.random().toString(36).substr(2);
            const newTask = {
              id: taskId,
              title: `URGENT: ${alertData.message}`,
              date: new Date().toISOString().split('T')[0],
              pivot: alertData.pivot,
              category: 'autre',
              priority: 'high',
              status: 'pending',
              createdAt: new Date().toISOString(),
              fromAlert: true,
              alertId: alertData.id
            };

            // Ajouter la t√¢che √† la liste des √©v√©nements
            const events = JSON.parse(localStorage.getItem('agricultureEvents')) || [];
            events.push(newTask);
            localStorage.setItem('agricultureEvents', JSON.stringify(events));

            console.log(`T√¢che urgente cr√©√©e pour ${alertData.pivot}: ${alertData.message}`);

            // Mettre √† jour l'historique pour indiquer qu'une t√¢che a √©t√© cr√©√©e √† partir de cette alerte
            updateAlertInHistory(alertData, taskId);
            break;
        }
      }

      // Fonction pour mettre √† jour une alerte dans l'historique
      function updateAlertInHistory(alertData, taskId) {
        // R√©cup√©rer les alertes existantes
        const alerts = JSON.parse(localStorage.getItem('agricultureAlerts')) || [];

        // Trouver l'alerte correspondante (la plus r√©cente avec le m√™me titre et message)
        const alertIndex = alerts.findIndex(alert =>
          alert.title === alertData.title &&
          alert.message === alertData.message
        );

        if (alertIndex !== -1) {
          // Mettre √† jour l'alerte avec l'ID de la t√¢che cr√©√©e
          alerts[alertIndex].taskId = taskId;
          alerts[alertIndex].taskCreated = true;

          // Sauvegarder le tableau mis √† jour
          localStorage.setItem('agricultureAlerts', JSON.stringify(alerts));
        }
      }

      // Fonction pour mettre √† jour l'√©tat d'un pivot
      function updatePivotState(pivotName, state) {
        localStorage.setItem(`etat_${pivotName}`, state);

        // Mettre √† jour visuellement si le pivot est affich√©
        const pivotCards = document.querySelectorAll('.pivot-card');
        pivotCards.forEach(card => {
          const name = card.querySelector('.pivot-name').textContent;
          if (name === pivotName) {
            if (state === 'probleme') {
              card.classList.add('probleme');
            } else {
              card.classList.remove('probleme');
            }
          }
        });
      }

      // D√©marrer la mise √† jour des capteurs
      setInterval(updateFakeSensorData, 8000); // Toutes les 8 secondes pour laisser le temps de voir les alertes
      updateFakeSensorData();

      // Gestion des alertes
      window.hideAlert = function() {
        const alert = document.getElementById('customAlert');
        alert.style.display = 'none';
      };

      // Initialisation des notifications
      function initNotifications() {
        // Vider la liste de notifications existante et r√©initialiser le compteur
        const notificationList = document.getElementById('notificationList');
        notificationList.innerHTML = '';
        document.getElementById('notificationBadge').textContent = '0';

        // Cr√©er des notifications initiales bas√©es sur l'√©tat des pivots
        const pivotDetails = JSON.parse(localStorage.getItem('pivotDetails')) || {};

        // V√©rifier s'il y a des pivots en √©tat probl√©matique
        let problemPivots = [];
        pivots.forEach(pivot => {
          const pivotState = localStorage.getItem(`etat_${pivot}`);
          if (pivotState === 'probleme') {
            problemPivots.push(pivot);
          }
        });

        // S'il y a des pivots probl√©matiques, cr√©er des alertes
        if (problemPivots.length > 0) {
          problemPivots.forEach(pivot => {
            createAlert({
              type: 'critical',
              title: 'Probl√®me technique d√©tect√©',
              message: `Dysfonctionnement sur ${pivot} n√©cessitant une intervention`,
              icon: 'exclamation-triangle',
              iconColor: '#dc3545',
              iconBg: '#f8d7da',
              pivot: pivot,
              action: 'create_task',
              actionMessage: `T√¢che urgente cr√©√©e: Maintenance requise sur ${pivot}`
            });
          });
        }

        // V√©rifier les pr√©visions m√©t√©o pour cr√©er des alertes pr√©ventives
        const currentTemp = document.getElementById('current-temp').textContent;
        const tempMax = document.getElementById('temp-max').textContent;

        if (parseInt(tempMax) > 35) {
          // Alerte de chaleur excessive
          createAlert({
            type: 'warning',
            title: 'Alerte m√©t√©o: Chaleur excessive',
            message: `Temp√©ratures √©lev√©es pr√©vues (${tempMax}¬∞C). Risque de stress hydrique pour les cultures.`,
            icon: 'thermometer-full',
            iconColor: '#ffc107',
            iconBg: '#fff3cd',
            pivot: 'Tous les pivots',
            action: 'create_task',
            actionMessage: 'Recommandation: Augmenter la fr√©quence d\'irrigation'
          });
        }

        // Simuler une d√©tection de maladie sur une culture (notification informative)
        setTimeout(() => {
          const randomPivotIndex = Math.floor(Math.random() * pivots.length);
          const randomPivot = pivots[randomPivotIndex];
          const pivotCrop = pivotDetails[randomPivot]?.crop || 'Ma√Øs';

          const diseases = {
            'Ma√Øs': 'Rouille commune',
            'Bl√©': 'O√Ødium',
            'Tomates': 'Mildiou',
            'Pommes de terre': 'Doryphore',
            'Palmiers dattiers': 'Bayoud'
          };

          const disease = diseases[pivotCrop] || 'Maladie fongique';

          createAlert({
            type: 'info',
            title: 'D√©tection pr√©coce de maladie',
            message: `Signes potentiels de ${disease} d√©tect√©s sur ${pivotCrop} (${randomPivot})`,
            icon: 'bug',
            iconColor: '#0dcaf0',
            iconBg: '#d1ecf1',
            pivot: randomPivot,
            action: 'create_task',
            actionMessage: `T√¢che cr√©√©e: Inspection et traitement pr√©ventif sur ${randomPivot}`
          });
        }, 15000);

        // Simuler une alerte de maintenance pr√©ventive
        setTimeout(() => {
          const randomPivotIndex = Math.floor(Math.random() * pivots.length);
          const randomPivot = pivots[randomPivotIndex];

          createAlert({
            type: 'info',
            title: 'Maintenance pr√©ventive',
            message: `Maintenance programm√©e recommand√©e pour ${randomPivot}`,
            icon: 'tools',
            iconColor: '#6c757d',
            iconBg: '#e9ecef',
            pivot: randomPivot,
            action: 'create_task',
            actionMessage: `T√¢che cr√©√©e: V√©rification des buses d'irrigation sur ${randomPivot}`
          });
        }, 25000);
      }

      // Fonction pour afficher/masquer le panneau de notifications
      window.toggleNotifications = function() {
        const panel = document.getElementById('notificationPanel');
        const icon = document.getElementById('notificationIcon').querySelector('i');

        if (panel.style.display === 'block') {
          panel.style.display = 'none';
        } else {
          panel.style.display = 'block';

          // Animer l'ic√¥ne
          icon.classList.add('ring-animation');
          setTimeout(() => {
            icon.classList.remove('ring-animation');
          }, 1500);
        }
      };

      // Fonction pour marquer toutes les notifications comme lues
      window.markAllAsRead = function() {
        const unreadItems = document.querySelectorAll('.notification-item.unread');
        unreadItems.forEach(item => {
          item.classList.remove('unread');
        });

        // Mettre √† jour le compteur
        document.getElementById('notificationBadge').textContent = '0';
      };

      // Fermer le panneau de notifications en cliquant √† l'ext√©rieur
      document.addEventListener('click', function(event) {
        const panel = document.getElementById('notificationPanel');
        const icon = document.getElementById('notificationIcon');

        if (panel.style.display === 'block' &&
            !panel.contains(event.target) &&
            !icon.contains(event.target)) {
          panel.style.display = 'none';
        }
      });
    });

    function loadPivots() {
      // Fetch pivots from the API
      fetch('/api/pivots.php')
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Store the pivot data in memory
            pivotData = data.pivots;

            // Extract pivot names for the UI
            pivots = data.pivots.map(pivot => pivot.name);

            // Update the UI
            updatePivotCards();
          } else {
            console.error('Failed to load pivots:', data.message);

            // Fallback to localStorage if API fails
            const savedPivots = localStorage.getItem('agriculturePivots');
            if (savedPivots) {
              pivots = JSON.parse(savedPivots);
              updatePivotCards();
            }
          }
        })
        .catch(error => {
          console.error('Error loading pivots:', error);

          // Fallback to localStorage if API fails
          const savedPivots = localStorage.getItem('agriculturePivots');
          if (savedPivots) {
            pivots = JSON.parse(savedPivots);
            updatePivotCards();
          }
        });
    }

    function updatePivotCards() {
      const container = document.getElementById('pivotsContainer');
      container.innerHTML = '';

      // Check if we have detailed pivot data from the API
      if (typeof pivotData !== 'undefined' && Array.isArray(pivotData)) {
        // Use the detailed pivot data from the API
        pivotData.forEach((pivot, index) => {
          // Get the pivot state from localStorage (this will be moved to the database later)
          const etatPivot = getEtatPivot(pivot.name);
          const problemClass = etatPivot === "probleme" ? "probleme" : "";

          container.innerHTML += `
            <div class="pivot-card ${problemClass}" onclick="handlePivotClick('${pivot.name}', ${index})" id="pivotCard-${index}" data-pivot-id="${pivot.id}">
              <input type="checkbox" class="delete-checkbox" id="checkbox-${index}" onclick="togglePivotSelection(event, '${pivot.name}', ${index})">
              <i class="fas fa-tint"></i>
              <span class="pivot-name">${pivot.name}</span>
              <span class="pivot-details" style="font-size: 0.7rem; display: block; margin-top: 5px;">${pivot.surface_area} ha - ${pivot.crop_type}</span>
            </div>
          `;
        });
      } else {
        // Fallback to simple pivot names from localStorage
        pivots.forEach((pivot, index) => {
          // Get the pivot state from localStorage
          const etatPivot = getEtatPivot(pivot);
          const problemClass = etatPivot === "probleme" ? "probleme" : "";

          container.innerHTML += `
            <div class="pivot-card ${problemClass}" onclick="handlePivotClick('${pivot}', ${index})" id="pivotCard-${index}">
              <input type="checkbox" class="delete-checkbox" id="checkbox-${index}" onclick="togglePivotSelection(event, '${pivot}', ${index})">
              <i class="fas fa-tint"></i>
              <span class="pivot-name">${pivot}</span>
            </div>
          `;
        });
      }
    }

    function handlePivotClick(pivotName, index) {
      if (deleteMode) {
        const checkbox = document.getElementById(`checkbox-${index}`);
        checkbox.checked = !checkbox.checked;
        togglePivotSelection(null, pivotName, index);
      } else {
        selectPivot(pivotName);
      }
    }
// --- Configuration globale ---
const intervalleCapteurs = {
  tempMin: 20,
  tempMax: 35,
  humidMin: 30,
  humidMax: 70
};

function getRandomValue(min, max) {
  return (Math.random() * (max - min) + min).toFixed(1);
}

function getEtatPivot(pivotName) {
  return localStorage.getItem(`etat_${pivotName}`) || "bon";
}

function getEtatIrrigation(pivotName) {
  return localStorage.getItem(`irrigation_${pivotName}`) || "desactive";
}

function selectPivot(pivotName) {
  const pivotCards = document.querySelectorAll('.pivot-card');
  pivotCards.forEach(card => {
    const name = card.querySelector('.pivot-name').textContent;
    const etat = getEtatPivot(name);

    card.classList.remove('active', 'probleme');

    if (name === pivotName) {
      card.classList.add('active');
    }

    if (etat === "probleme") {
      card.classList.add('probleme');
    }
  });

  const events = JSON.parse(localStorage.getItem('agricultureEvents')) || [];
  const pivotTasks = events.filter(event => event.pivot === pivotName);

  let tasksHtml = '';
  if (pivotTasks.length > 0) {
    tasksHtml = `
      <table class="table table-sm table-bordered mt-3">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Heure</th>
            <th>T√¢che</th>
            <th>Cat√©gorie</th>
          </tr>
        </thead>
        <tbody>
    `;
    pivotTasks.forEach(task => {
      const taskDate = new Date(task.date);
      const formattedDate = taskDate.toLocaleDateString('fr-FR');
      const formattedTime = task.category === 'irrigation'
        ? `${task.startTime} - ${task.endTime}`
        : 'Toute la journ√©e';

      tasksHtml += `
        <tr>
          <td>${formattedDate}</td>
          <td>${formattedTime}</td>
          <td>${task.title}</td>
          <td>${getCategoryLabel(task.category)}</td>
        </tr>
      `;
    });
    tasksHtml += `</tbody></table>`;
  } else {
    tasksHtml = `<p class="text-muted mt-3">Aucune t√¢che planifi√©e pour ce pivot.</p>`;
  }

  // √âtat
  let etatPivot = getEtatPivot(pivotName);
  let etatIrrigation = getEtatIrrigation(pivotName);

  let etatTechText = etatPivot === "bon"
    ? '<span class="text-success"><i class="fas fa-check-circle me-1"></i>Bon √©tat</span>'
    : '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Probl√®me technique</span>';

  let etatIrrigText = etatIrrigation === "active"
    ? '<span class="text-success"><i class="fas fa-play me-1"></i>En cours d‚Äôirrigation</span>'
    : '<span class="text-secondary"><i class="fas fa-pause me-1"></i>Irrigation d√©sactiv√©e</span>';

    const bgEtatColor = etatPivot === "bon" ? "#e6f4ea" : "#f8d7da";
    const borderEtatColor = etatPivot === "bon" ? "#c3e6cb" : "#f5c6cb";


  // Get pivot details from API data if available
  let pivotDetail = null;
  if (typeof pivotData !== 'undefined' && Array.isArray(pivotData)) {
    pivotDetail = pivotData.find(p => p.name === pivotName);
  }

  // Get surface and crop type from API data or fallback to localStorage
  let surface = '4';
  let cropType = 'Ma√Øs';
  let location = 'B√©char - Secteur Sud';
  let notes = '';

  if (pivotDetail) {
    surface = pivotDetail.surface_area;
    cropType = pivotDetail.crop_type;
    location = pivotDetail.location || 'B√©char - Secteur Sud';
    notes = pivotDetail.notes || '';
  } else {
    // Fallback to localStorage
    const pivotDetails = JSON.parse(localStorage.getItem('pivotDetails')) || {};
    if (pivotDetails[pivotName]) {
      surface = pivotDetails[pivotName].surface || '4';
      cropType = pivotDetails[pivotName].crop || 'Ma√Øs';
      location = pivotDetails[pivotName].location || 'B√©char - Secteur Sud';
      notes = pivotDetails[pivotName].notes || '';
    }
  }

  // Obtenir la saison actuelle
  const currentSeason = getCurrentSeason();

  // V√©rifier si la culture est adapt√©e √† la saison actuelle
  const cropData = CROP_REQUIREMENTS[cropType];
  const isSeasonAppropriate = cropData && cropData.seasons && cropData.seasons.includes(currentSeason.name);

  // Calculer le pourcentage de progression du cycle de croissance (simul√©)
  const cycleProgress = Math.floor(Math.random() * 100);

  // --- SweetAlert Popup ---
  Swal.fire({
    title: `<h5 class="text-primary mb-2">üíß ${pivotName}</h5>`,
    html: `
      <div class="text-start text-muted" style="font-size: 0.95rem; border: 1px solid #c3e6cb">
        <div class="mb-3 p-2 bg-light rounded border" style="background-color: #e6f4ea; border: 1px solid #c3e6cb">
          <div class="d-flex justify-content-between align-items-center mb-2">
            <strong class="text-dark">üìç Localisation</strong>
            <span class="badge bg-info">
              <i class="fas fa-${currentSeason.name === 'Printemps' ? 'seedling' :
                              currentSeason.name === '√ât√©' ? 'sun' :
                              currentSeason.name === 'Automne' ? 'leaf' : 'snowflake'} me-1"></i>
              Saison: ${currentSeason.name}
            </span>
          </div>
          <div><i class="fas fa-map-marker-alt me-2 text-info"></i> ${location}</div>
          <div><i class="fas fa-ruler-combined me-2 text-success"></i> Surface : ${surface} hectares</div>
          <div class="d-flex justify-content-between align-items-center">
            <div><i class="fas fa-seedling me-2 text-success"></i> Culture : ${cropType}</div>
            ${cropData ?
              `<span class="badge ${isSeasonAppropriate ? 'bg-success' : 'bg-warning'}">
                ${isSeasonAppropriate ? '‚úì Adapt√© √† la saison' : '‚ö†Ô∏è Hors saison'}
              </span>` : ''}
          </div>
          <div><i class="fas fa-clock me-2 text-muted"></i> Derni√®re utilisation : ${new Date().toLocaleDateString('fr-FR')}</div>
          ${notes ? `<div><i class="fas fa-sticky-note me-2 text-warning"></i> Notes : ${notes}</div>` : ''}

          ${cropData ? `
            <div class="mt-3 pt-2 border-top">
              <strong class="text-dark d-block mb-1">üå± Informations sur la culture</strong>
              <div><i class="fas fa-info-circle me-2 text-primary"></i> Type: ${cropData.type}</div>
              <div><i class="fas fa-tint me-2 text-primary"></i> Besoins en eau: ${cropData.waterNeeds}</div>
              <div><i class="fas fa-calendar-alt me-2 text-primary"></i> Cycle: ${cropData.cycleLength}</div>
              <div class="mt-2">
                <small class="d-block mb-1">Progression du cycle:</small>
                <div class="progress" style="height: 10px;">
                  <div class="progress-bar bg-success" role="progressbar" style="width: ${cycleProgress}%;"
                       aria-valuenow="${cycleProgress}" aria-valuemin="0" aria-valuemax="100">${cycleProgress}%</div>
                </div>
              </div>
            </div>
          ` : ''}
        </div>

        <div class="mb-3 p-2 rounded" style="background-color: ${bgEtatColor}; border: 1px solid ${borderEtatColor}">
          <strong class="text-dark d-block mb-1">‚öôÔ∏è √âtat technique</strong>
          <div id="etat-pivot">${etatTechText}</div>
          <button id="btn-changer-etat" class=class="btn btn-sm btn-outline-success">Changer l‚Äô√©tat</button>
        </div>

        <div class="mb-3 p-2 rounded border" style="background-color: #e6f4ea;">
          <strong class="text-success d-block mb-1">üíß √âtat d‚Äôirrigation</strong>
          <div id="etat-irrigation">${etatIrrigText}</div>
          <button id="btn-changer-irrigation" class="btn btn-sm btn-outline-success mt-2">Activer / D√©sactiver</button>
        </div>

        <div class="mb-3 p-2 rounded border" style="background-color: #e6f4ea;">
          <strong class="text-dark d-block mb-1">üìä Capteurs</strong>
          <div>üå°Ô∏è Temp√©rature du sol : <span id="temp-sol"></span> ¬∞C</div>
          <div>üíß Humidit√© du sol : <span id="humid-sol"></span> %</div>
        </div>

        <div class="mt-3">
          <h6 class="text-dark">üóìÔ∏è Historique de planification</h6>
          ${tasksHtml}
        </div>
      </div>
    `,
    showCloseButton: true,
    confirmButtonText: 'Fermer',
    customClass: {
      popup: 'border rounded shadow',
      confirmButton: 'btn btn-sm btn-primary'
    },
    width: 600,
    background: '#fff',
    focusConfirm: false,

    didOpen: () => {
      function updateSensorData() {
        document.getElementById('temp-sol').textContent = getRandomValue(intervalleCapteurs.tempMin, intervalleCapteurs.tempMax);
        document.getElementById('humid-sol').textContent = getRandomValue(intervalleCapteurs.humidMin, intervalleCapteurs.humidMax);
        const intervalId = setInterval(updateSensorData, 10000);
      }


      updateSensorData();
      const intervalId = setInterval(updateSensorData, 10000);

      Swal.getPopup().addEventListener('mouseleave', () => clearInterval(intervalId));
      Swal.getCloseButton().addEventListener('click', () => clearInterval(intervalId));

      // √âtat technique
      document.getElementById('btn-changer-etat').addEventListener('click', () => {
      // Inverser l'√©tat
      etatPivot = (etatPivot === "bon") ? "probleme" : "bon";
      localStorage.setItem(`etat_${pivotName}`, etatPivot);

      // Mettre √† jour le texte
      const newText = etatPivot === "bon"
        ? '<span class="text-success"><i class="fas fa-check-circle me-1"></i>Bon √©tat</span>'
        : '<span class="text-danger"><i class="fas fa-exclamation-triangle me-1"></i>Probl√®me technique</span>';
      document.getElementById('etat-pivot').innerHTML = newText;

      // üé® Changer la couleur de la section
      const sectionEtat = document.getElementById('etat-pivot').parentElement;
      sectionEtat.style.backgroundColor = (etatPivot === "bon") ? "#e6f4ea" : "#f8d7da";
      sectionEtat.style.border = (etatPivot === "bon") ? "1px solid #c3e6cb" : "1px solid #f5c6cb";

      // üé® Changer la couleur du bouton
      document.getElementById('btn-changer-etat').className =
        `btn btn-sm mt-2 btn-outline-${etatPivot === 'bon' ? 'success' : 'danger'}`;

      // üé® Mettre √† jour la carte du pivot
      const card = [...document.querySelectorAll('.pivot-card')].find(card => card.querySelector('.pivot-name').textContent === pivotName);
      if (card) {
        card.classList.toggle('probleme', etatPivot === "probleme");
      }
    });


      // √âtat irrigation
      document.getElementById('btn-changer-irrigation').addEventListener('click', () => {
        etatIrrigation = (etatIrrigation === "active") ? "desactive" : "active";
        localStorage.setItem(`irrigation_${pivotName}`, etatIrrigation);

        const newText = etatIrrigation === "active"
          ? '<span class="text-success"><i class="fas fa-play me-1"></i>En cours d‚Äôirrigation</span>'
          : '<span class="text-secondary"><i class="fas fa-pause me-1"></i>Irrigation d√©sactiv√©e</span>';

        document.getElementById('etat-irrigation').innerHTML = newText;
      });
    }
  });
}


  const pivotCards = document.querySelectorAll('.pivot-card');
  pivotCards.forEach(card => {
    if (card.querySelector('.pivot-name').textContent === pivotName) {
      card.classList.add('active');
    } else {
      card.classList.remove('active');
    }
  });

  // R√©cup√©rer les t√¢ches depuis localStorage
  const events = JSON.parse(localStorage.getItem('agricultureEvents')) || [];
  const pivotTasks = events.filter(event => event.pivot === pivotName);

  // G√©n√©rer le tableau HTML
  let tasksHtml = '';
  if (pivotTasks.length > 0) {
    tasksHtml = `
      <table class="table table-sm table-bordered mt-3">
        <thead class="table-light">
          <tr>
            <th>Date</th>
            <th>Heure</th>
            <th>T√¢che</th>
            <th>Cat√©gorie</th>
          </tr>
        </thead>
        <tbody>
    `;

    pivotTasks.forEach(task => {
      const taskDate = new Date(task.date);
      const formattedDate = taskDate.toLocaleDateString('fr-FR');
      const formattedTime = task.category === 'irrigation'
        ? `${task.startTime} - ${task.endTime}`
        : 'Toute la journ√©e';

      tasksHtml += `
        <tr>
          <td>${formattedDate}</td>
          <td>${formattedTime}</td>
          <td>${task.title}</td>
          <td>${getCategoryLabel(task.category)}</td>
        </tr>
      `;
    });

    tasksHtml += `</tbody></table>`;
  } else {
    tasksHtml = `<p class="text-muted mt-3">Aucune t√¢che planifi√©e pour ce pivot.</p>`;
  }





function getCategoryLabel(category) {
  const labels = {
    'irrigation': 'Irrigation',
    'fertilisation': 'Fertilisation',
    'recolte': 'R√©colte',
    'traitement': 'Traitement',
    'autre': 'Autre'
  };
  return labels[category] || category;
}




    function addNewPivot() {
        // Obtenir la saison actuelle
        const currentSeason = getCurrentSeason();

        // Organiser les cultures par type et filtrer par saison appropri√©e
        const cropsByType = {};

        // Parcourir toutes les cultures d√©finies dans CROP_REQUIREMENTS
        Object.entries(CROP_REQUIREMENTS).forEach(([cropName, cropData]) => {
          // V√©rifier si cette culture est adapt√©e √† la saison actuelle
          const isSeasonAppropriate = cropData.seasons && cropData.seasons.includes(currentSeason.name);

          // Organiser par type
          if (!cropsByType[cropData.type]) {
            cropsByType[cropData.type] = [];
          }

          // Ajouter la culture √† son type avec indication de saison
          cropsByType[cropData.type].push({
            name: cropName,
            isSeasonAppropriate: isSeasonAppropriate
          });
        });

        // Cr√©er la liste des cultures disponibles, organis√©es par type
        let cropTypes = [];

        // Ajouter d'abord les cultures de saison
        Object.entries(cropsByType).forEach(([type, crops]) => {
          // Ajouter les cultures appropri√©es pour la saison actuelle en premier
          const seasonalCrops = crops
            .filter(crop => crop.isSeasonAppropriate)
            .map(crop => crop.name);

          if (seasonalCrops.length > 0) {
            cropTypes = cropTypes.concat(seasonalCrops);
          }
        });

        // Ajouter ensuite les cultures hors saison
        Object.entries(cropsByType).forEach(([type, crops]) => {
          const nonSeasonalCrops = crops
            .filter(crop => !crop.isSeasonAppropriate)
            .map(crop => crop.name);

          if (nonSeasonalCrops.length > 0) {
            cropTypes = cropTypes.concat(nonSeasonalCrops);
          }
        });

        // Ajouter "Autre" √† la fin
        cropTypes.push('Autre');

        // Cr√©er les options pour le s√©lecteur de cultures
        const cropOptions = cropTypes.map(crop =>
          `<option value="${crop}">${crop}</option>`
        ).join('');

        Swal.fire({
          title: '<h5 class="text-primary mb-3"><i class="fas fa-plus-circle me-2"></i>Ajouter un nouveau pivot</h5>',
          html: `
            <form id="newPivotForm" class="text-start">
              <div class="mb-3">
                <label for="pivotName" class="form-label fw-bold">Nom du pivot <span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="pivotName" placeholder="Ex: Pivot Nord" required>
                <div class="invalid-feedback">Veuillez entrer un nom pour le pivot</div>
              </div>

              <div class="mb-3">
                <label for="pivotSurface" class="form-label fw-bold">Surface (hectares) <span class="text-danger">*</span></label>
                <input type="number" class="form-control" id="pivotSurface" placeholder="Ex: 4.5" min="0.1" step="0.1" required>
                <div class="invalid-feedback">Veuillez entrer une surface valide</div>
              </div>

              <div class="mb-3">
                <label for="pivotCrop" class="form-label fw-bold">Culture <span class="text-danger">*</span></label>
                <div class="d-flex align-items-center mb-2">
                  <span class="badge bg-info me-2">Saison actuelle: ${currentSeason.name}</span>
                  <i class="fas fa-${currentSeason.name === 'Printemps' ? 'seedling' :
                                    currentSeason.name === '√ât√©' ? 'sun' :
                                    currentSeason.name === 'Automne' ? 'leaf' : 'snowflake'} me-2"></i>
                </div>
                <select class="form-select" id="pivotCrop" required>
                  <option value="" disabled selected>S√©lectionnez une culture...</option>

                  <!-- Cultures recommand√©es pour la saison -->
                  <optgroup label="‚úÖ Recommand√© pour ${currentSeason.name}">
                    ${Object.entries(CROP_REQUIREMENTS)
                      .filter(([_, data]) => data.seasons && data.seasons.includes(currentSeason.name))
                      .map(([crop, _]) => `<option value="${crop}">${crop}</option>`)
                      .join('')}
                  </optgroup>

                  <!-- Autres cultures (hors saison) -->
                  <optgroup label="‚ö†Ô∏è Hors saison ou conditions difficiles">
                    ${Object.entries(CROP_REQUIREMENTS)
                      .filter(([_, data]) => !data.seasons || !data.seasons.includes(currentSeason.name))
                      .map(([crop, _]) => `<option value="${crop}">${crop}</option>`)
                      .join('')}
                  </optgroup>

                  <option value="Autre">Autre...</option>
                </select>
                <div class="invalid-feedback">Veuillez indiquer la culture</div>
                <small class="text-muted mt-1">Les cultures recommand√©es sont adapt√©es √† la saison actuelle (${currentSeason.name}).</small>
              </div>

              <!-- Informations sur la culture s√©lectionn√©e -->
              <div id="cropInfo" class="mb-3 p-2 rounded border" style="display: none; background-color: #f8f9fa;">
                <h6 class="mb-2"><i class="fas fa-info-circle me-2"></i>Informations sur la culture</h6>
                <div id="cropInfoContent"></div>
              </div>

              <div class="mb-3">
                <label for="pivotLocation" class="form-label fw-bold">Localisation</label>
                <input type="text" class="form-control" id="pivotLocation" placeholder="Ex: Secteur Sud">
              </div>

              <div class="mb-3">
                <label for="pivotNotes" class="form-label fw-bold">Notes</label>
                <textarea class="form-control" id="pivotNotes" rows="2" placeholder="Informations suppl√©mentaires..."></textarea>
              </div>
            </form>
          `,
          showCancelButton: true,
          confirmButtonColor: '#88c9a1',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Ajouter',
          cancelButtonText: 'Annuler',
          focusConfirm: false,
          didOpen: () => {
            // Ajouter un √©couteur d'√©v√©nement pour afficher les informations sur la culture s√©lectionn√©e
            const cropSelect = document.getElementById('pivotCrop');
            const cropInfo = document.getElementById('cropInfo');
            const cropInfoContent = document.getElementById('cropInfoContent');

            cropSelect.addEventListener('change', function() {
              const selectedCrop = this.value;
              const cropData = CROP_REQUIREMENTS[selectedCrop];

              if (cropData && selectedCrop !== 'Autre') {
                // Afficher les informations sur la culture
                cropInfoContent.innerHTML = `
                  <div class="row">
                    <div class="col-md-6">
                      <p><strong>Type:</strong> ${cropData.type}</p>
                      <p><strong>Cycle de croissance:</strong> ${cropData.cycleLength}</p>
                      <p><strong>Besoins en eau:</strong> ${cropData.waterNeeds}</p>
                    </div>
                    <div class="col-md-6">
                      <p><strong>Saisons optimales:</strong> ${cropData.seasons.join(', ')}</p>
                      <p><strong>Temp√©rature optimale:</strong> ${cropData.temperature.air.min}¬∞C - ${cropData.temperature.air.max}¬∞C</p>
                      <p><strong>Humidit√© optimale:</strong> ${cropData.humidity.soil.min}% - ${cropData.humidity.soil.max}%</p>
                    </div>
                  </div>
                  <p class="mb-0"><strong>Description:</strong> ${cropData.description}</p>
                  ${!cropData.seasons.includes(getCurrentSeason().name) ?
                    `<div class="alert alert-warning mt-2 mb-0 py-1 px-2">
                      <small><i class="fas fa-exclamation-triangle me-1"></i>Cette culture n'est pas id√©ale pour la saison actuelle (${getCurrentSeason().name}).</small>
                    </div>` : ''}
                `;
                cropInfo.style.display = 'block';
              } else {
                // Masquer les informations sur la culture
                cropInfo.style.display = 'none';
              }
            });
          },

          preConfirm: () => {
            // R√©cup√©rer les valeurs du formulaire
            const name = document.getElementById('pivotName').value.trim();
            const surface = document.getElementById('pivotSurface').value;
            const crop = document.getElementById('pivotCrop').value;
            const location = document.getElementById('pivotLocation').value.trim();
            const notes = document.getElementById('pivotNotes').value.trim();

            // Valider les champs obligatoires
            let isValid = true;

            if (!name) {
              document.getElementById('pivotName').classList.add('is-invalid');
              isValid = false;
            } else {
              document.getElementById('pivotName').classList.remove('is-invalid');
            }

            if (!surface || isNaN(surface) || parseFloat(surface) <= 0) {
              document.getElementById('pivotSurface').classList.add('is-invalid');
              isValid = false;
            } else {
              document.getElementById('pivotSurface').classList.remove('is-invalid');
            }

            if (!crop) {
              document.getElementById('pivotCrop').classList.add('is-invalid');
              isValid = false;
            } else {
              document.getElementById('pivotCrop').classList.remove('is-invalid');
            }

            if (!isValid) {
              return false;
            }

            // Retourner les donn√©es du pivot
            return {
              name: name,
              surface: parseFloat(surface),
              crop: crop,
              location: location || 'Non sp√©cifi√©',
              notes: notes || '',
              createdAt: new Date().toISOString()
            };
          }
        }).then((result) => {
          if (result.isConfirmed && result.value) {
            // Show loading indicator
            Swal.fire({
              title: 'Enregistrement en cours...',
              html: 'Veuillez patienter pendant l\'enregistrement du pivot.',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            // Prepare data for API
            const pivotData = {
              name: result.value.name,
              surface_area: result.value.surface,
              crop_type: result.value.crop,
              location: result.value.location,
              notes: result.value.notes,
              status: 'active'
            };

            // Save to API
            fetch('/api/pivots.php', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json'
              },
              body: JSON.stringify(pivotData)
            })
            .then(response => response.json())
            .then(data => {
              if (data.success) {
                // Reload pivots from API
                loadPivots();

                // Show success message
                Swal.fire({
                  icon: 'success',
                  title: 'Pivot ajout√©!',
                  text: `Pivot "${result.value.name}" ajout√© avec succ√®s!`,
                  confirmButtonColor: '#88c9a1'
                });
              } else {
                // Show error message
                Swal.fire({
                  icon: 'error',
                  title: 'Erreur',
                  text: data.message || 'Erreur lors de l\'ajout du pivot',
                  confirmButtonColor: '#dc3545'
                });

                // Fallback to localStorage
                const pivotDetails = JSON.parse(localStorage.getItem('pivotDetails')) || {};
                pivots.push(result.value.name);
                pivotDetails[result.value.name] = result.value;
                localStorage.setItem('pivotDetails', JSON.stringify(pivotDetails));
                localStorage.setItem('agriculturePivots', JSON.stringify(pivots));
                updatePivotCards();
              }
            })
            .catch(error => {
              console.error('Error saving pivot:', error);

              // Show error message
              Swal.fire({
                icon: 'error',
                title: 'Erreur',
                text: 'Erreur de connexion lors de l\'ajout du pivot',
                confirmButtonColor: '#dc3545'
              });

              // Fallback to localStorage
              const pivotDetails = JSON.parse(localStorage.getItem('pivotDetails')) || {};
              pivots.push(result.value.name);
              pivotDetails[result.value.name] = result.value;
              localStorage.setItem('pivotDetails', JSON.stringify(pivotDetails));
              localStorage.setItem('agriculturePivots', JSON.stringify(pivots));
              updatePivotCards();
            });
          }
        });
      }

      function toggleDeleteMode() {
        deleteMode = !deleteMode;
        const container = document.getElementById('pivotsContainer');
        const deleteActions = document.getElementById('deleteActions');
        const deleteModeBtn = document.getElementById('deleteModeBtn');

        if (deleteMode) {
          container.classList.add('delete-mode');
          deleteActions.style.display = 'flex';
          deleteModeBtn.classList.add('active');
          selectedPivots = [];
        } else {
          container.classList.remove('delete-mode');
          deleteActions.style.display = 'none';
          deleteModeBtn.classList.remove('active');
          document.querySelectorAll('.pivot-card.selected, .delete-checkbox').forEach(el => {
            el.classList?.remove('selected');
            el.checked = false;
          });
        }
      }

      function togglePivotSelection(event, pivotName, index) {
        if (event) event.stopPropagation();

        const card = document.getElementById(`pivotCard-${index}`);
        const checkbox = document.getElementById(`checkbox-${index}`);

        if (checkbox.checked) {
          card.classList.add('selected');
          if (!selectedPivots.includes(pivotName)) selectedPivots.push(pivotName);
        } else {
          card.classList.remove('selected');
          selectedPivots = selectedPivots.filter(p => p !== pivotName);
        }
      }

      function deleteSelectedPivots() {
        if (selectedPivots.length === 0) {
          showAlert('danger', 'Aucun pivot s√©lectionn√©!');
          return;
        }

        Swal.fire({
          title: 'Confirmer la suppression',
          html: `Supprimer <b>${selectedPivots.length}</b> pivot(s)?<br>Cette action est irr√©versible!`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonColor: '#ff6b6b',
          cancelButtonColor: '#6c757d',
          confirmButtonText: 'Oui, supprimer',
          cancelButtonText: 'Annuler'
        }).then((result) => {
          if (result.isConfirmed) {
            // Show loading indicator
            Swal.fire({
              title: 'Suppression en cours...',
              html: 'Veuillez patienter pendant la suppression des pivots.',
              allowOutsideClick: false,
              didOpen: () => {
                Swal.showLoading();
              }
            });

            // If we have pivot data from the API, use it to get the pivot IDs
            if (typeof pivotData !== 'undefined' && Array.isArray(pivotData)) {
              // Get the pivot IDs for the selected pivots
              const selectedPivotIds = [];

              for (const pivotName of selectedPivots) {
                const pivot = pivotData.find(p => p.name === pivotName);
                if (pivot) {
                  selectedPivotIds.push(pivot.id);
                }
              }

              // Delete each pivot from the API
              const deletePromises = selectedPivotIds.map(pivotId => {
                return fetch(`/api/pivots.php?id=${pivotId}`, {
                  method: 'DELETE'
                }).then(response => response.json());
              });

              // Wait for all delete operations to complete
              Promise.all(deletePromises)
                .then(results => {
                  // Check if all deletes were successful
                  const allSuccessful = results.every(result => result.success);

                  if (allSuccessful) {
                    // Reload pivots from API
                    loadPivots();

                    // Show success message
                    Swal.fire({
                      icon: 'success',
                      title: 'Pivots supprim√©s!',
                      text: `${selectedPivots.length} pivot(s) supprim√©(s) avec succ√®s!`,
                      confirmButtonColor: '#88c9a1'
                    });

                    // Exit delete mode
                    toggleDeleteMode();
                  } else {
                    // Show error message
                    Swal.fire({
                      icon: 'error',
                      title: 'Erreur',
                      text: 'Erreur lors de la suppression de certains pivots',
                      confirmButtonColor: '#dc3545'
                    });

                    // Fallback to localStorage
                    pivots = pivots.filter(pivot => !selectedPivots.includes(pivot));
                    localStorage.setItem('agriculturePivots', JSON.stringify(pivots));
                    updatePivotCards();
                    toggleDeleteMode();
                  }
                })
                .catch(error => {
                  console.error('Error deleting pivots:', error);

                  // Show error message
                  Swal.fire({
                    icon: 'error',
                    title: 'Erreur',
                    text: 'Erreur de connexion lors de la suppression des pivots',
                    confirmButtonColor: '#dc3545'
                  });

                  // Fallback to localStorage
                  pivots = pivots.filter(pivot => !selectedPivots.includes(pivot));
                  localStorage.setItem('agriculturePivots', JSON.stringify(pivots));
                  updatePivotCards();
                  toggleDeleteMode();
                });
            } else {
              // Fallback to localStorage
              pivots = pivots.filter(pivot => !selectedPivots.includes(pivot));
              localStorage.setItem('agriculturePivots', JSON.stringify(pivots));
              updatePivotCards();

              // Show success message
              showAlert('success', `${selectedPivots.length} pivot(s) supprim√©(s)!`);
              toggleDeleteMode();
            }
          }
        });
      }

      function cancelDeleteMode() {
        toggleDeleteMode();
      }

      function savePivots() {
        // This function is now just a wrapper for loadPivots
        // since pivots are saved to the database via the API
        loadPivots();
      }

      /* ********************** */
      /* FONCTIONS M√âT√âO        */
      /* ********************** */

      async function fetchWeatherData() {
        const apiKey = 'a162c938e49d47143cfe359703f7f716';
        const lat = 31.6167;
        const lon = -2.2167;

        try {
          const [currentResponse, forecastResponse] = await Promise.all([
            fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lon}&units=metric&lang=fr&appid=${apiKey}`),
            fetch(`https://api.openweathermap.org/data/2.5/forecast?lat=${lat}&lon=${lon}&units=metric&lang=fr&appid=${apiKey}`)
          ]);

          updateCurrentWeather(await currentResponse.json());
          updateForecast(await forecastResponse.json());
        } catch (error) {
          console.error('Erreur m√©t√©o:', error);
          const weatherDesc = document.getElementById('weather-description');
          weatherDesc.textContent = 'Donn√©es non disponibles';
          weatherDesc.className = 'error-message';
        }
      }

      function updateCurrentWeather(data) {
        document.getElementById('current-temp').textContent = Math.round(data.main.temp);
        document.getElementById('weather-description').textContent =
          data.weather[0].description.charAt(0).toUpperCase() + data.weather[0].description.slice(1);
        document.getElementById('wind-speed').textContent = (data.wind.speed * 3.6).toFixed(1);
        document.getElementById('humidity').textContent = data.main.humidity;
        document.getElementById('temp-max').textContent = Math.round(data.main.temp_max);
        document.getElementById('temp-min').textContent = Math.round(data.main.temp_min);

        const weatherIcon = document.getElementById('current-weather-icon');
        weatherIcon.className = getWeatherIconClass(data.weather[0].icon) + ' weather-icon';
      }

      function updateForecast(data) {
        const forecastContainer = document.getElementById('forecast-container');
        if (!forecastContainer) return;

        const dailyForecasts = [];
        const daysAdded = new Set();

        data.list.forEach(forecast => {
          const date = new Date(forecast.dt * 1000);
          const dayKey = date.toLocaleDateString('fr-FR', { weekday: 'short' });

          if (!daysAdded.has(dayKey) && daysAdded.size < 5) {
            daysAdded.add(dayKey);
            dailyForecasts.push({
              day: dayKey,
              temp: Math.round(forecast.main.temp),
              icon: forecast.weather[0].icon
            });
          }
        });

        forecastContainer.innerHTML = dailyForecasts.map(day => `
          <div class="forecast-day">
            <div class="d-flex align-items-center">
              <p class="mb-0">${day.day}</p>
              <i class="${getWeatherIconClass(day.icon)} ms-2"></i>
            </div>
            <p class="mb-0">${day.temp}¬∞C</p>
          </div>
        `).join('');
      }

      function getWeatherIconClass(weatherCode) {
        const iconMap = {
          '01d': 'fas fa-sun', '01n': 'fas fa-moon',
          '02d': 'fas fa-cloud-sun', '02n': 'fas fa-cloud-moon',
          '03d': 'fas fa-cloud', '03n': 'fas fa-cloud',
          '09d': 'fas fa-cloud-rain', '09n': 'fas fa-cloud-rain',
          '10d': 'fas fa-cloud-showers-heavy', '10n': 'fas fa-cloud-showers-heavy',
          '11d': 'fas fa-bolt', '11n': 'fas fa-bolt',
          '13d': 'fas fa-snowflake', '13n': 'fas fa-snowflake',
          '50d': 'fas fa-smog', '50n': 'fas fa-smog'
        };
        return iconMap[weatherCode] || 'fas fa-question';
      }

      /* ********************** */
      /* FONCTIONS CAPTEURS     */
      /* ********************** */

      function updateFakeSensorData() {
        document.getElementById("temp").innerText = (20 + Math.random() * 10).toFixed(1) + " ¬∞C";
        document.getElementById("humid").innerText = (30 + Math.random() * 20).toFixed(1) + " %";
        document.getElementById("humid-air").innerText = (40 + Math.random() * 30).toFixed(1) + " %";
        document.getElementById("light").innerText = (10000 + Math.random() * 50000).toFixed(0) + " lux";
      }

      /* ********************** */
      /* FONCTIONS STATISTIQUES */
      /* ********************** */

      function updateStats() {
        document.getElementById('water-usage').textContent = (Math.random() * 50 + 10).toFixed(1);
        document.getElementById('crop-growth').textContent = (Math.random() * 30 + 70).toFixed(0) + '%';
        document.getElementById('fertilizer-usage').textContent = Math.round(Math.random() * 20 + 5);
        document.getElementById('pest-alerts').textContent = Math.round(Math.random() * 3);
      }

      /* ********************** */
      /* FONCTIONS CARTE        */
      /* ********************** */

      function initMap() {
        const map = L.map('map').setView([31.6167, -2.2167], 12);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
          attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        L.marker([31.6167, -2.2167]).addTo(map)
          .bindPopup('<b>B√©char</b><br>Zone agricole principale')
          .openPopup();

        L.circle([31.6167, -2.2167], {
          color: '#4CAF50',
          fillColor: '#4CAF50',
          fillOpacity: 0.2,
          radius: 2000
        }).addTo(map).bindPopup('Zone agricole de B√©char');
      }

      /* ********************** */
      /* FONCTIONS UTILITAIRES  */
      /* ********************** */

      function showAlert(type, message) {
        const alert = document.getElementById('customAlert');
        const alertMessage = document.getElementById('alertMessage');

        alert.className = `custom-alert alert alert-dismissible fade show alert-${type}-custom`;
        alertMessage.innerHTML = `<i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>${message}`;
        alert.style.display = 'block';

        setTimeout(hideAlert, 5000);
      }

      function hideAlert() {
        document.getElementById('customAlert').style.display = 'none';
      }

      /* ********************** */
      /* FONCTIONS AUTHENTIFICATION */
      /* ********************** */

      // Check if user is logged in and has the correct role
      function checkUserAuthentication() {
        if (!window.Auth || !window.Auth.isLoggedIn()) {
          // User is not logged in, redirect to login page
          window.location.href = 'login.html';
          return;
        }

        // Check if user has the correct role (gestionnaire or admin)
        const userRole = window.Auth.getCurrentUserRole();
        if (userRole !== 'gestionnaire' && userRole !== 'admin') {
          // User is not a gestionnaire, redirect to employe dashboard
          window.location.href = 'dashboard_employe.html';
        }
      }

      // Initialize logout functionality
      function initLogout() {
        const logoutBtn = document.getElementById('logoutBtn');
        const confirmLogoutBtn = document.getElementById('confirmLogout');
        const logoutModal = new bootstrap.Modal(document.getElementById('logoutModal'));

        // Show logout confirmation modal when logout button is clicked
        logoutBtn.addEventListener('click', function(e) {
          e.preventDefault();
          logoutModal.show();
        });

        // Handle logout confirmation
        confirmLogoutBtn.addEventListener('click', function() {
          // Show loading spinner
          confirmLogoutBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>D√©connexion...';
          confirmLogoutBtn.disabled = true;

          // Simulate a delay for the logout process
          setTimeout(function() {
            // Use the Auth module to logout
            if (window.Auth && typeof window.Auth.logoutUser === 'function') {
              window.Auth.logoutUser();
            } else {
              console.log('Auth object not available, using fallback logout');
              // Fallback logout method
              const users = JSON.parse(localStorage.getItem('agricultureUsers')) || [];
              const currentUserId = localStorage.getItem('currentUserId');

              // Find the current user and update status to offline
              const userIndex = users.findIndex(u => u.id == currentUserId);
              if (userIndex !== -1) {
                users[userIndex].status = 'offline';
                localStorage.setItem('agricultureUsers', JSON.stringify(users));
              }

              // Clear current user ID
              localStorage.removeItem('currentUserId');
              localStorage.removeItem('isLoggedIn');
            }

            // Redirect to landing page
            window.location.href = 'index.html';
          }, 1000);
        });
      }
    </script>
    <script src="js/auth.js"></script>
    <script src="js/pivot-details.js"></script>
    <script src="js/role-permissions.js"></script>
  </body>
  </html>
